
 Lightweight Directory Access Protocol


- [[#Classes d'objet]]
- [[#Requêtes LDAP]]

- [[#Enumération de l'AD]]

---
## Classes d'objet

- computer / ordinateur
- domain
- group / groupe
- person / personne
- groupPolicyContainer
- organizationalUnit / Unité d'organisation
- trustedDomain

---
## Requêtes LDAP

> [!Attention]
> Considérations OPSEC :
> 	- **Expensive Search Results Threshold** -> Attention aux requêtes qui retournent énormément de résultats (objectClass=* par exemple)
> 	- **Search Time Threshold** -> Attention aux requêtes trop lentes (nombre de résultats + trop d'attributs à retourner).
> 	- **Inefficient Search Results Threshold** -> Attention aux requêtes inefficientes (Peu de résultat par rapport aux nombre d'objets énumérés). Dans certains cas il vaut mieux énumérer les détails importants de tous les utilisateurs d'un coup avec quelques attributs spécifiques, mais cela peut déclencher l' Expensive Search Results Threshold

### Méthodologie de requêtes

> [!Warning]
> Utiliser des petites requêtes au maximum ciblées sur plusieurs jours / semaines afin d'être discret.


### Operateurs

- ET -> &
- OU -> |
- NOT -> !

### Indexes

Rechercher par index permet de cibler de manière plus précise nos requête avec l'attribut samAccountType :

https://learn.microsoft.com/en-us/windows/win32/adschema/a-samaccounttype

### Filtres

Filtrer sur les users (index 805306368 = SAM_NORMAL_USER_ACCOUNT)

```
ldapsearch (samAccountType=805306368)
```

Filtrer sur les users ayant le Admincount 1

```
ldapsearch (&(samAccountType=805306368)(adminCount=1))
```

### Attributs

Liste d'attributs interessants:
- name
- memberof -> Utile pour les membres de groupe
- ntsecuritydescriptor -> Indispensable pour les DACL dans Bloodhound
- samaccountname
- distinguishedname
- useraccountcontrol -> contient les flags (compte activé, trusted for delegations etc...)


ajouter le flag --attributes suivit des attributs

```
--attributes name,memberof,ntsecuritydescriptor
```

```
ldapsearch (samAccountType=805306368) --attributes name,memberof,ntsecuritydescriptor
```


### Bitwise

Permet de matcher les valeurs avec les attribus.

1.2.840.113556.1.4.803 -> Doit matcher entièrement
1.2.840.113556.1.4.804 -> Doit matcher si un caractère de la chaine correspond
1.2.840.113556.1.4.1941 -> Matcher les Distinguished Name d'un objet et cherche les ownership et membership entries. (utile pour énumérer les groupes dans les groupes)


---
## Enumération de l'AD

> [!Rappel]
> Utiliser des petites requêtes au maximum ciblées sur plusieurs jours / semaines afin d'être le plus discret possible.

### Cobalt Strike

Utilise le BOF ldapsearch.


Infos à collecter :
- [[#Domaine]]
- [[#Users, Groups & Computers]]
- [[#Users à privilèges]]
- [[#OUs & GPOs]]
- [[#Delegations Kerberos]]
- [[#Domain Trusts]]

Puis parser les logs avec [[2. BOFHound|BOFHound]] et BloodHound


#### Domaine

1. Identifier les infos sur le domaine

```
ldapsearch (objectClass=domain) --attributes *,ntsecuritydescriptor
```


#### Users, Groups & Computers

1. Identifier tous les users

```
ldapsearch (samAccountType=805306368) --attributes *,ntsecuritydescriptor
```

2. Identifier tous les groupes

```
ldapsearch (samAccountType=268435456) --attributes *,ntsecuritydescriptor
```

3. Identifier tous les computers et leur UAC

```
ldapsearch (samAccountType=805306369) --attributes *,ntsecuritydescriptor
```


#### Users à privilèges

1. Identifier les users ayant le Admincount 1

```
ldapsearch (&(samAccountType=805306368)(adminCount=1)) --attributes *,ntsecuritydescriptor
```

2. Identifier les membres du groupe Domain Admins

```
ldapsearch "(memberof:1.2.840.113556.1.4.1941:=CN=Domain Admins,CN=Users,DC=contoso,DC=com)" --attributes *,ntsecuritydescriptor
```



#### OUs & GPOs

1. Identifier les OUs

```
ldapsearch (objectClass=organizationalUnit) --attributes *,ntsecuritydescriptor
```

2. Identifier les GPOs

```
ldapsearch (objectClass=groupPolicyContainer) --attributes *,ntsecuritydescriptor
```



#### Delegations Kerberos

1. Identifier les délégations non contraintes

```
ldapsearch (&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)) --attributes samaccountname
```

2. Identifier les délégations contraintes

```
ldapsearch (&(samAccountType=805306369)(msDS-AllowedToDelegateTo=*)) --attributes samAccountName,msDS-AllowedToDelegateTo
```

3. Identifier les RBCD

```
ldapsearch (&(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*)) --attributes samAccountName,msDS-AllowedToActOnBehalfOfOtherIdentity
```



#### Domain Trusts

TrustDirections :
-  trustDirection 3 -> Bidirectionelle
-  trustDirection 2 -> Unidirectionnelle en outbound (on fait confiance à l'autre domaine)
-  trustDirection 1 -> Unidirectionnelle en inbound (l'autre domaine nous fait confiance)

TrustAttributes:
- 1 -> NON_TRANSITIVE
- 4 -> SID Filtering en place
- 8 -> FOREST_TRANSITIVE (Entre 2 forêts)
- 32 -> WITHIN_FOREST (Entre 2 Domaines au sein de la même forêt)
- 64 -> TREAT_AS_EXTERNAL (Entre 2 Domaines au sein de 2 forêts différentes)

1. Identifier les domain Trust

```
ldapsearch (objectClass=trustedDomain) --attributes samAccountName --dn DC=domain,DC=com --hostname domain.com
```


2. Identifier les trust accounts (samAccountType of `SAM_TRUST_ACCOUNT`)

```
ldapsearch (samAccountType=805306370) --attributes samAccountName --dn DC=domain,DC=com --hostname domain.com
```

