
Partie la plus importante de la chaine d'infection.

- [[#Payloads]]
- [[#Signature de code]]

# Payloads

- [[#DLL Side-Loading]]
- [[#AppDomainManager]]
- [[#Windows Installer]]
- [[#Excel Add-In's]]


## DLL Side-Loading

[[DLL HIJACKING WINDOWS#DLL Side-Loading]]

## AppDomainManager

[[DLL HIJACKING WINDOWS#AppDomainManager]]


## Windows Installer

Générer un .MSI malveillant.

1. Créer un nouveau projet visual studio "Setup Project" (nécessite l'extension [Installer Projects](https://marketplace.visualstudio.com/items?itemName=VisualStudioClient.MicrosoftVisualStudio2022InstallerProjects))

![[Pasted image 20250911013147.png]]

2. Ajouter l'exécutable malveillant en fichier

![[Pasted image 20250911014047.png]]

3. Mettre l'application en Hidden True et définir un nom de sortie.

![[Pasted image 20250911014142.png]]

4. Ajouter une Custom action afin que le payload soit exécuté durant l'installation.

![[Pasted image 20250911145524.png]]

5. Clique droit sur Install -> Add Custom Action
6. Sélectionner l'executable dans application folder

![[Pasted image 20250911145646.png]]

7. Si Payload 64 bit, Mettre Run64bit à true. Indiquer les arguments /install /quiet

![[Pasted image 20250911145703.png]]

8. Modifier les propriétés du projet afin de définir un nom de société, Fabricant, Nom de produit et titre -> Change le nom du répertoire crée dans ProgramFiles et dans les applications installés.

![[Pasted image 20250911150333.png]]

9. Etape finale -> Envoyer le .MSI à la victime, la compilation du projet sort egalement un .exe mais il n'est pas nécessaire puisqu'il ne sert qu'à exécuter le .MSI.


---
## Excel Add-In's

Permet de créer un fichier Add-In Excel embarquant des macros au format **.xlam**.
Un use case typique consiste à bind une macro à un bouton sur le ruban afin d'exécuter des tâches.

Par défaut Office désactive les macros lorsque le document ne provient pas d'une source de confiance. (Mark of the Web)

Les répertoires source jugés comme zone de confiance sont les suivants :

- %ProgramFiles%\Microsoft Office\root\Office16\Library\
    
- %ProgramFiles%\Microsoft Office\root\Office16\STARTUP\
    
- %ProgramFiles%\Microsoft Office\root\Office16\XLSTART\
    
- %ProgramFiles%\Microsoft Office\root\Templates\
    
- %APPDATA%\Microsoft\Excel\XLSTART\
    
- %APPDATA%\Microsoft\Templates\

Program Files est protégé en écriture mais pas %APPDATA%. Noter également que ce qui est présent dans XLSTART sera chargé automatiquement au démarrage d'Excel.

### Créer un XLAM

1. Lancer Excel, créer un fichier blank et faire la combinaison de touches ALT + F11.
2. Faire clique droit sur VBAProject et séléctionner Insert -> Module

![[Pasted image 20250911152034.png]]

3. Ajouter notre macro (https://github.com/S3cur3Th1sSh1t/OffensiveVBA)

```
Private Sub Auto_Open()
   MsgBox "Hello World", vbOKOnly, "pwned"
End Sub
```

4. Fermer l'éditeur et enregistrer sous -> **Excel Add-In (*.xlam)**.
5. Copier le fichier dans %APPDATA%\Microsoft\Excel\XLSTART afin de tester.
6. Fermer et réouvrir Excel, la macro devrait s'éxecuter sans message d'alerte.





---
# Signature de code


Demander des certificats à des autorités comme Digicert ou GlobalSign est compliqué car demande de suivre un processus long. De plus un certificat tel que RedTeam certificate est très facilement identifiable et bloquable par la victime.

L'idée est de rechercher des certificats légitimes qui ont leakés ou été volés, sur des repos GitHub, S3 Bucket public, forums etc... et de signer notre payload avec.

