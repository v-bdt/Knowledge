

# Structure d'un PE

Un PE contient les informations nécessaires sur un programme pour qu'il puisse être chargé en mémoire.

![[Pasted image 20250909010953.png]]


## DOS Header

Structure fixée à 64 octets appelée 'Image DOS Header' présente dans chaque PE.
Contient 2 éléments importants:
- e_magic -> Le Magic Number (MZ ou 4D 5A dans le cas d'un PE).
- e_lfanew -> Contient l'offset (adresse mémoire) vers l'entête du PE. Se situe toujours à l'offset 0x3C et tient sur 4 octets. 
- 
![[Pasted image 20250909014845.png]]

## DOS Stub

Utilisé uniquement si le PE est exécuté sous MS-DOS -> Message "This program cannot be run in DOS mode".

![[Pasted image 20250909014853.png]]

## NT Headers

- IMAGE_NT_HEADERS -> 32 bits
- IMAGE_NT_HEADERS64 -> 64 bits
- Signature du PE -> 50 45 00 00 -> Vérifie que le début du NT header a bien été chargé.
- File header -> IMAGE_FILE_HEADER -> contient 7 membres dont:
	- **Machine** -> WORD de 2 octets indiquant l'architecture du CPU pour lequel est compilé le PE. -> https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#machine-types
	- **NumberOfSections** -> WORD contenant le nombre de sections du PE.
	- **SizeOfOptionalHeader** -> Contient la taille des headers optionnels
	- **Characteristics** -> Flag décrivant certains attributs du PE.

![[Pasted image 20250909014905.png]]
- Optional header -> IMAGE_OPTIONAL_HEADER32 ou IMAGE_OPTIONAL_HEADER64
	- **Magic** -> Determine PE32 ou PE32+ (64 bits)
	- **AddressOfEntryPoint** -> L'adresse du point d'entrée lors du chargement en mémoire.
	- **ImageBase** -> L'adresse de base préférée pour le chargement du PE
	- **NumberOfRvaAndSizes** -> La taille du tableau *DataDirectory*
	- **DataDirectory** -> Tableau contenant les structures de IMAGE_DATA_DIRECTORY

![[Pasted image 20250909014921.png]]

## Data Directories

La structure IMAGE_DATA_DIRECTORY contient 2 membres:
- **VirtualAddress** -> Pointe vers le début d'une structure data directory spécifique.
- **Size** -> Taille de ce data directory.

```C++
typedef struct _IMAGE_DATA_DIRECTORY {
    DWORD   VirtualAddress;
    DWORD   Size;
} I
```

## Sections

Contient les données et code exécuté par le programme.

![[Pasted image 20250329220419.png]]

Chaque section est succédée à un header qui la décrit:
- **Name** -> Nome de la section
- **VirtualSize** -> Taille de la section
- **VirtualAddress** -> Adresse mémoire de la section lors de son chargement en mémoire. (Offset relatif à l'adresse de base de l'image)
- **SizeOfRawData** -> Taille de la section en dur sur le disque.
- **Characteristics** -> un set de flags qui décrivent les caractéristiques de la section (Permissions R, RW, RX par exemple)

